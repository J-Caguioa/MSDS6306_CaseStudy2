---
title: "Analysis"
author: "Lavonnia Newman, Jeff Washburn, & Joseph Caguioa"
date: "2/25/2019"
output: 
  html_document:
    theme: default
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false

---

```{r setup, include=F, message=F, results="hide", warning=F}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)

package_list <- c("tidyverse", "readxl", "knitr", "mlr", "kableExtra", "corrplot", "ggmosaic", "magrittr", "caret", "randomForest", "reshape", "gridExtra", "GGally", "purrr")
lapply(package_list, library, character.only=T)

theme_set(theme_bw())

source('src/MLR-2.R')

```

# Introduction

DDSAnalytics provides talent management solutions for Fortune 1000 companies. For these highly influential and competitive American companies, employee retention is critical for productivity, morale, and the bottom line. Therefore, identifying factors that could possibly predict employee turnover and then developing appropriate retention strategies is of great interest.

Our team of data scientists will analyze an existing data set of employee survey responses to identify major factors that contributed to attrition. Additionally, we will also point out other interesting trends that may provide insights for future development and retention strategies.

# 2. Load/Clean Data

```{r load1}

# Read in data set. [#2A]
employee <- read_excel('Data/DDSAnalytics_Data.xlsx', sheet = "HR-employee-attrition Data")

# Obtain dimensions. [#2A]
employee_dim <- as.matrix(dim(employee))
rownames(employee_dim) <- c("Rows", "Columns")
kable(employee_dim, col.names = "Size", row.names = T,
      caption = "Data Set Dimensions", table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

The original data set provided by DDSAnalytics contains observations on 1,470 employees with information on 35 variables. In other words, the data set comprises a data frame of 1,470 rows and 35 columns. Whether this data comes from one company or multiple is unspecified.

```{r load2, message=F, warning=F}

# Modify column names. All names less than 12 characters. [#2B]
renamed <- read_excel('Data/VariableNames.xlsx')
colnames(employee) <- renamed$`Modified_Name`

# Convert column types. [#2D]
employee_factor <- data.frame(employee)
employee_factor <- employee_factor %>% mutate_if(is.character, as.factor)
factor_cols <- c("Education", "EmpCount", "EnvironSat", "JobInvolvemt", "JobLevel", "JobSat", "PerfRating", "RelationSat", "StandHours", "StckOptLev", "WorkLifeBal")
employee_factor %<>% mutate_each(funs(factor(.)), factor_cols)

employee_numeric <- data.frame(employee_factor)
employee_numeric %<>% mutate_if(is.factor, as.numeric)

```

Two versions of the original employee data frame are created. One converts all character variables and select rating-type numeric variables to factors. The other goes a step further and coerces all variables to numeric. Both are used in different ways during the analysis.

```{r eda-plots1, message=F, warning=F}

# Exploratory histograms of continuous variables.
employee_factor %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales="free") +
    geom_histogram() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1))

```

Quick exploratory plots of all 35 variables on all of the data reveal some useful tidbits right off the bat. The histogram shapes alone show some interesting trends.

* Distance From Home, Percent Salary Increase, Total Working Years, Years At Company, Years In Current Role, Years Since Last Promotion, and Years With Current Manager have similar positively skewed distributions with long right tails. Some of these variables are likely correlated with each other.
* Employee ID has a maximum value above 2000. The data set contains only 1,470 observations, meaning this may be a subset where other employee data has already been removed.

```{r eda-plots2, message=F, warning=F}

# Exploratory bar graphs of factor variables.
employee_factor %>%
  keep(is.factor) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales="free") +
    geom_bar() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))

```

The exploratory bar graphs are similarly informative.

* Department shows that most employees are in Research & Development, followed by Sales. On a related note, Job Role shows most employees are Sales Executives, Research Scientists, or Laboratory Technicians; Education Field shows most have a background in Life Sciences or Medical. Job Level for most is 1 or 2.
* Employee Count 1 for all employees in the data set because each row corresponds to answers for only one employee.
* Environment Satisfacion, Job Satisfaction, and Relationship Satisfaction have noticeable proportions of dissatisfied employees.
* Over 18 is Yes for all employees (including employees who are 18 years old).
* Performance Rating, defined on a scale of 1 to 4, only has scores of 3 and 4 represented.
* Standard Hours is 80 for all employees in the data set. Assuming a standard 40-hour workweek, all of the represented companies use bi-weekly paychecks.

```{r na}

# Has the Qualtrics system introduced any errors? [#2C]
colSums(is.na(employee_factor))

```

None of the quick graphs above threw any errors indicating that missing errors were removed before plotting. There are no NA values for any variable. Furthermore, there are no outliers that could indicate entry errors.

```{r drop}

# Remove <18-year-olds. [#3A]
count(employee, "Over18")

# Remove unnecessary variables.
drop <- c("EmpCount", "EmpId", "Over18", "StandHours")
employee_factor <- employee_factor[ , !(names(employee_factor) %in% drop)]
employee_numeric <- employee_numeric[ , !(names(employee_numeric) %in% drop)]

```

As shown in the bar graph above, the Over 18 variable indicates that all employees are at least 18 years old. Furthermore, its total count matches the total number of observations. The minimum age (shown below), 18, confirms that there are no underage employees in the data set.

Before proceeding further, any variables with no variation (Employee Count, Over 18, and Standard Hours) can be removed because they have no more useful information. Employee ID can also be removed because observations can be tracked by other means. This results in a data frame of 1,470 rows and 31 columns.

# 3. Preliminary Analysis

## 3b. Descriptive stats

```{r descriptive,echo=TRUE}
# Descriptive statistics (7) and histograms (2) for interesting variables. [#3B]
# Age, MnthInc, PcntSalInc, YrsAtComp, YrsCurrRole, YrsSncPromo, YrsWtCurMgr

descriptiveStats = employee[c("Age", "MnthInc", "PcntSalInc", "YrsAtComp", "YrsCurrRole", "YrsSncPromo", "YrsWtCurMgr")]

kable(summary(descriptiveStats))


# Descriptive stats - Age
summary(employee$Age)

# Descriptive stats - MnthInc
summary(employee$MnthInc)

# Descriptive stats - PcntSalInc
summary(employee$PcntSalInc)

# Descriptive stats - YrsAtComp
summary(employee$YrsAtComp)

# Descriptive stats - YrsCurrRole
summary(employee$YrsCurrRole)

# Descriptive stats - YrsSncPromo
summary(employee$YrsSncPromo)

# Descriptive stats - YrsWtCurMgr
summary(employee$YrsWtCurMgr)


# Histogram - age
# 
summary(employee$Age)
ggAge = ggplot(employee, aes(Age))
ggAge = ggAge +geom_histogram(breaks=seq(18, 60, by=2), col="black", aes(fill=..count.., y=..density..)) 
ggAge = ggAge +scale_fill_gradient("Count", low="green", high="red")
ggAge = ggAge +geom_density(col="blue")
ggAge = ggAge +labs(title="Histogram for Age", x="Age", y="Density")
ggAge

# Histogram - Income
summary(employee$MnthInc)
ggIncome = ggplot(employee, aes(MnthInc))
ggIncome = ggIncome +geom_histogram(breaks=seq(1000, 22000, by=1000), col="black", aes(fill=..count.., y=..density..))
ggIncome = ggIncome +scale_fill_gradient("Count", low="green", high="red")
ggIncome = ggIncome +geom_density(col="blue")
ggIncome = ggIncome +labs(title="Histogram for Income", x="Income", y="Density")
ggIncome
```

## 3c. Frequencies on Gender, Education, Occupation

```{r frequencies}

GenderData<- table(employee$Gender)
kable(GenderData,
      col.names = c("Gender",
                    "Count"),
      row.names = T,
      caption="Headcount By Gender",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


EducationData <- table(employee$Education)
names(EducationData)<-c("Below College", "College", "Bachelor", "Master", "Doctor")
kable(EducationData,
      col.names = c("Education Level", "Count"),
      row.names = T,
      caption="Headcount by Education",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


```

## 3d. Counts of Management positions

```{r management}

managerRoles<-c("Manager", "Manufacturing Director", "Research Director")
ManagerRoleData<- employee[employee$JobRole %in% managerRoles, ]
ManagerRoleData <- data.frame(table(ManagerRoleData$JobRole))
names(ManagerRoleData) <- c("JobRoles", "Count")
kable(ManagerRoleData,
      col.names = c("Job Role", "Count"),
      row.names = T,
      caption="Headcount by Manager Role",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

# 4. Deep Analysis

## Correlation

``` {r correlations1, warning=F}

# Show correlating variables for further investigation.
corrplot(cor(employee_numeric), type = "upper", tl.col = "black", tl.srt = 45, tl.cex = 0.5, number.cex = 0.3)

```

For reference, the correlogram shows some correlations between the following variables ("Years%" refers to the last four variables beginning with the word "Years"):

* Age: Education, JobLevel, MonthlyIncome, TotalWorkingYears, Years%
* Department: JobRole
    + Possibly makes sense, as certain job roles tend to be used in certain departments. Cross-reference back to original factors; the numeric coercion may be creating noise.
* Education: NumCompaniesWorked, TotalWorkingYears
* JobLevel: MonthlyIncome, TotalWorkingYears, Years%
* MaritalStatus: StockOptionLevel
* MonthlyIncome: Age, TotalWorkingYears, Years%
    + Likely increases with experience
* NumCompaniesWorked: TotalWorkingYears
* PercentSalaryHike: PerformanceRating
    + According to FAQs, data is self-reported. Performance rating is likely artificially high.
* TotalWorkingYears: Age, JobLevel, MonthlyIncome, Years%
* Years%: Other Years%

```{r correlations2}

# Divorced = 1, Married = 2, Single = 3. All Singles have StockOptionLevel = 0.
table(employee_numeric$MaritalStat, employee_numeric$StckOptLev)

# Overtime 1 = No, 2 = Yes. About the same percentage of people worked overtime, regardless of marital status.
table(employee_numeric$MaritalStat, employee_numeric$Overtime)

# Percentagewise, marital status distributed evenly by job level.
table(employee_numeric$MaritalStat, employee_numeric$JobLevel)

```

Attrition's individual correlations are relatively weak. Perhaps studying interaction effects will show a stronger effect.

* Attrition: Age, EnvironmentSatisfaction, JobInvolvement, JobLevel, JobSatisfaction, MaritalStatus, MonthlyIncome, OverTime, StockOptionLevel, TotalWorkingYears, YearsAtCompany, YearsInCurrentRole, YearsWithCurrManager
    + MaritalStatus and OverTime show positive correlations, the rest are negative. Makes sense in context for some, eg, lower JobInvolvement/Level/Satisfaction increases likelihood of attrition?

## 4c. Age and Income

```{r age-income}

# Relationship between Age and Income. [#4C]
cor(employee$Age, employee$MnthInc)

lm1 <- lm(MnthInc ~ Age, employee)
summary(lm1)

ggplot(employee, aes(x=Age, y=MnthInc, color=Gender)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income Rises with Age") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)

par(mfrow=c(2,2))
plot(lm1)

```

A moderate positive correlation (Pearson's r = 0.498) exists between age and monthly income. Drawing a scatterplot between the two shows a general upward trend in income as age increases, and the best-fitting regression line has a positive slope. However, a linear relationship may not be an optimal model for these variables.

```{r income-vs-others}

# Relationship between education and income.
ggplot(employee, aes(x=factor(Education), y=MnthInc, group=Education, fill=Education)) +
  geom_boxplot() +
  xlab("Level of Education") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income and Education") +
  scale_x_discrete(labels = c("Below College",
                              "College",
                              "Bachelor",
                              "Master",
                              "Doctor")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.ticks = element_blank(),
        legend.position = 'none',
        plot.title = element_text(hjust = 0.5))

# Relationship between education field and income.
ggplot(employee, aes(x=EduField, y=MnthInc, group=EduField)) +
  geom_boxplot() +
  coord_flip()

# Total working years vs income
ggplot(employee, aes(x=TotalWrkYrs, y=MnthInc)) +
  geom_point()

lm2 <- lm(MnthInc ~ TotalWrkYrs, employee)
cor(employee$TotalWrkYrs, employee$MnthInc)
# Note: 0.77 cor, R2 ~ 0.597 ***

# Years at company vs income
ggplot(employee, aes(x=YrsAtComp, y=MnthInc)) +
  geom_point()

```

## Rates & Income

The data set contains four variables related to money: Hourly Rate, Daily Rate, Monthly Rate, and Monthly Income. Their data definitions are not well-defined, but it can be reasonably assumed that the "Rate" variables relate to wages earned over the indicated unit of time and the "Income" variable translates to monthly take-home pay. If this is the case, can a model can be built to describe the relationship between them?

```{r rate-income1, message=F, warning=F}

# Visualize relationship between rates and income.
ggpairs(employee_factor, aes(color=Attrition, alpha=0.1), 
        columns=c("HourlyRate", "DailyRate", "MnthRate", "MnthInc"),
        title="Correlation Matrix for Monetary Variables and Attrition",
        axisLabels="none",
        upper=list(continuous=wrap("cor", size=3, hjust=0.8)))

```

Scatterplots of the rates and income variables against each other do not show any discernible relationship; the correlation values, being near zero, would suggest that no relationship exists at all. This is an unexpected result, as one would expect that these variables would trend together. Perhaps another variable not captured by the data, or the survey method by which the data was collected from employees, is responsible.

Another oddity reveals itself when we compare the minimum and maximum values for each variable.

```{r rate-income2}

# Divide data based on which of Monthly Income and Rate is greater.
MnthIncGreater <- summary(employee_factor[which(employee_factor$MnthRate < employee_factor$MnthInc), ])
MnthRateGreater <- summary(employee_factor[which(employee_factor$MnthRate > employee_factor$MnthInc), ])

# Display lower and upper bounds for each category.
employee_money <- data.frame(
  rbind(c(min(employee_numeric$HourlyRate), max(employee_numeric$HourlyRate)),
        c(min(employee_numeric$DailyRate), max(employee_numeric$DailyRate)),
        c(min(employee_numeric$MnthRate), max(employee_numeric$MnthRate)),
        c(min(employee_numeric$MnthInc), max(employee_numeric$MnthInc))))
row.names(employee_money) <- c("Hourly Rate", "Daily Rate", "Monthly Rate", "Monthly Income")
colnames(employee_money) <- c("Minimum", "Maximum")

kable(employee_money,
      col.names = c("Minimum", "Maximum"),
      row.names = T,
      caption="Rates & Income Bounds",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

For all observations, Monthly Rate is greater than Daily Rate, which in turn is greater than Hourly Rate. This is expected. However, Monthly Rate is greater than Monthly Income for only `r round(mean(employee_numeric$MnthRate > employee_numeric$MnthInc) * 100, digits=2)`% of the observations; in other words, 258 of the 1,470 employees reported a greater Monthly Income than Monthly Rate. Assuming the above interpretation of rate as pre-deduction and income as post-deduction earnings is accurate, why might this be?

## Job-Specific Trends

```{r job-role}

# Relationship between job role and monthly income.
job_mnthinc <- employee_factor %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), y=MnthInc, group=JobRole, fill=JobRole)) +
  geom_boxplot() + 
  coord_flip() +
  ylab("Monthly Income ($)") + 
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x=element_text(size=6, angle=45, vjust=1, hjust=1),
        axis.text.y=element_text(size=6),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank(),
        legend.position="none")

# Relationship between job role and years at current company.
job_yearscomp <- employee_factor %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), y=YrsAtComp, group=JobRole)) +
  geom_boxplot() +
  coord_flip() +
  ylab("Years at Current Company") +
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x=element_text(size=6, angle=45, vjust=1, hjust=1),
        axis.text.y=element_text(size=6),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank(),
        legend.position="none")  


# Relationship between job role and attrition.
job_att <- ggplot(employee_factor, aes(x=reorder(JobRole, desc(JobRole)), y=..count..)) +
  geom_bar(aes(fill=Attrition), position="fill") +
  coord_flip() +
  ylab("Percentage") +
  scale_fill_manual("Attrition", values=c("Yes"="indianred3", "No"="seagreen3")) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())


# Relationship between job role and job satisfaction.
job_co_worked <- ggplot(employee, aes(x=JobRole, y=NumCoWorked, group=JobRole)) +
  geom_boxplot() + coord_flip() +
  xlab("Job Role") + ylab("Number of Companies Worked") + ylim(c(0,10)) + ggtitle("Work History by Job")
job_sat <- ggplot(employee, aes(x=JobRole, y=JobSat)) +
  geom_boxplot() + coord_flip() +
  xlab("Job Role") + ylab("Job Satisfaction") + ggtitle("Job Satisfaction by Role")
job_salinc <- ggplot(employee, aes(x=JobRole, y=PcntSalInc)) +
  geom_boxplot() + coord_flip() +
  xlab("Job Role") + ylab("Percent Salary Increase") + ggtitle("Yearly Raise by Job")
job_bal <- ggplot(employee, aes(x=JobRole, y=WorkLifeBal)) +
  geom_jitter(alpha=0.3) + coord_flip() +
  xlab("Job Role") + ylab("Work-Life Balance") + ggtitle("Work Life Balance by Job")

grid.arrange(job_mnthinc, job_yearscomp, job_co_worked, job_sat, job_salinc, job_bal, ncol=2)

job_att
```

```{r job-stackedbars}

# employee_factor %>% 
#   mutate(BusTravel=fct_relevel(BusTravel,"Non-Travel", "Travel_Rarely", "Travel_Frequently")) %>% 
#   ggplot(aes(x=reorder(JobRole, desc(JobRole)), y=..count..)) +
#   geom_bar(aes(fill=BusTravel), position="fill") +
#   coord_flip() +
#   ylab("Percentage") +
#   scale_color_distiller(palette="RdPu") +
# #  scale_fill_manual("Attrition", values=c("No"="seagreen3", "Yes"="indianred3")) +
#   theme(axis.text.x=element_text(size=8),
#         axis.text.y=element_text(size=8),
#         axis.ticks.y = element_blank(),
#         axis.title.x = element_text(size=10),
#         axis.title.y = element_blank())

# Reusable Likert scale colors.
likert <- c("1"="indianred3", "2"="bisque1", "3"="olivedrab3", "4"="springgreen3")

# Relationship between job role and environment satisfaction.
job_envsat <- employee_factor %>% 
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), y=..count..)) +
  geom_bar(aes(fill=EnvironSat), position=position_fill(reverse=T)) +
  coord_flip() +
  ylab("Cumulative Proportion") +
  scale_fill_manual("Job Satisfaction", values=likert) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank(),
        legend.position="top")

# Relationship between job role and job satisfaction.
job_jobsat <- employee_factor %>% 
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), y=..count..)) +
  geom_bar(aes(fill=JobSat), position=position_fill(reverse=T)) +
  coord_flip() +
  ylab("Cumulative Proportion") +
  scale_fill_manual("Job Satisfaction", values=likert) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank(),
        legend.position="top")

# Relationship between job role and relationship satisfaction.
job_relsat <- employee_factor %>% 
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), y=..count..)) +
  geom_bar(aes(fill=RelationSat), position=position_fill(reverse=T)) +
  coord_flip() +
  ylab("Cumulative Proportion") +
  scale_fill_manual("Relationship Satisfaction", values=likert) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank(),
        legend.position="top")

# Relationship between job role and work life balance.
job_wlb <- employee_factor %>% 
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), y=..count..)) +
  geom_bar(aes(fill=WorkLifeBal), position=position_fill(reverse=T)) +
  coord_flip() +
  ylab("Cumulative Proportion") +
  scale_fill_manual("Work Life Balance", values=likert) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank(),
        legend.position="top")

grid.arrange(job_envsat, job_jobsat, job_relsat, ncol=2)

```

```{r test2}

job_yearscomp <- employee_factor %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), y=YrsAtComp, group=JobRole)) +
  geom_boxplot() +
  coord_flip() +
  ylab("Years at Current Company") +
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x=element_text(size=6, angle=45, vjust=1, hjust=1),
        axis.text.y=element_text(size=6),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank(),
        legend.position="none")  
job_yearscomp

```

## Attrition

```{r attrition1}

# Percent of employees who left.
mean(employee_factor$Attrition == "Yes")

# Subset data and retrieve summary statistics on employees who left.
attrition <- employee_factor[employee_factor$Attrition == "Yes", ]
attrition_summary <- data.frame(do.call('rbind', lapply(attrition, function(x) if(is.numeric(x)) round(summary(x),2))))
attrition_summary$Mean <- round(attrition_summary$Mean, digits=2)
colnames(attrition_summary) <- c("Minimum", "1st Quartile", "Median", "Mean", "3rd Quartile", "Maximum")
kable(attrition_summary, row.names = T,
      caption = "Statistics of People Who Left", 
      table.attr="style='width:90%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Density plots to show trends for numeric variables.
att_dist <- ggplot(employee_factor, aes(x=DistFromHme, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Distance from Home") +
  ylab("Density")

att_inc <- ggplot(employee_factor, aes(x=NumCoWorked, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Number of Companies Worked") +
  ylab("Density")

att_age <- ggplot(employee_factor, aes(x=Age, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Age") +
  ylab("Density")

att_hrrate <- ggplot(employee_factor, aes(x=HourlyRate, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Hourly Rate") +
  ylab("Density")

att_totyrs <- ggplot(employee_factor, aes(x=TotalWrkYrs, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Total Working Years") +
  ylab("Density")

att_yrscmp <- ggplot(employee_factor, aes(x=YrsAtComp, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Years at Company") +
  ylab("Density")

att_mthinc <- ggplot(employee_factor, aes(x=MnthInc, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Monthly Income") +
  ylab("Density")

att_yrscur <- ggplot(employee_factor, aes(x=YrsCurrRole, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Years in Current Role") +
  ylab("Density")

grid.arrange(att_inc, att_dist, ncol=2)
grid.arrange(att_age, att_hrrate, ncol=2)
grid.arrange(att_totyrs, att_yrscmp, ncol=2)
grid.arrange(att_mthinc, att_yrscur, ncol=2)

# Mosaic plots to show proportions for factor variables.
par(mfrow=c(1,2))
att_job <- mosaicplot(Attrition ~ JobRole,
                      data=employee_factor,
                      color=T,
                      main="Attrition on Job Roles")
att_stock <- mosaicplot(Attrition ~ StckOptLev, 
                        data = employee_factor, 
                        color=T,
                        main="Attrition on Stock Options")
att_bal <- mosaicplot(Attrition ~ WorkLifeBal,
                      data=employee_factor,
                      color=T,
                      main="Attrition on Work Life Balance")
att_jobsat <- mosaicplot(Attrition ~ JobSat,
                         data=employee_factor,
                         color=T,
                         main="Attrition on Job Satisfaction")
att_relsat <- mosaicplot(Attrition ~ RelationSat,
                         data=employee_factor,
                         color=T,
                         main="Attrition on Relationship Satisfaction")
att_marsat <- mosaicplot(Attrition ~ MaritalStat,
                         data=employee_factor,
                         color=T,
                         main="Attrition on Marital Status")
att_edu <- mosaicplot(Attrition ~ Education,
                         data=employee_factor,
                         color=T,
                         main="Attrition on Education Level")
att_edufld <- mosaicplot(Attrition ~ EduField,
                         data=employee_factor,
                         color=T,
                         main="Attrition on Education Field")
att_gen <- mosaicplot(Attrition ~ Gender,
                         data=employee_factor,
                         color=T,
                         main="Attrition on Gender")
att_joblvl <- mosaicplot(Attrition ~ JobLevel,
                         data=employee_factor,
                         color=T,
                         main="Attrition on Job Level")
att_joblvl <- mosaicplot(Attrition ~ BusTravel,
                         data=employee_factor,
                         color=T,
                         main="Attrition on Business Travel")

```

From the summary statistics and density and mosaic plots, a general trend emerges on what the typical leaving employee generally looks like compared to an employee who stays:

* Younger (especially in the 20s and 30s) and single
* Lower job and relationship satisfaction
* No stock option
* Live further from work and travel more frequently for business
* Hold lower job level

Which of these factors are the biggest determinants for attrition?

```{r attrition2}

# # Stratified sampling on Attrition.
# set.seed(307)
# train_rows <- createDataPartition(y=employee_factor$Attrition, p=0.7, list=F)
# train_subset <- employee_factor[train_rows,]
# test_subset <- employee_factor[-train_rows,]
# 
# # Create task.
# train_task <- makeClassifTask(data=train_subset, target="Attrition", positive="Yes")
# test_task <- makeClassifTask(data=test_subset, target="Attrition")
# 
# train_task
# 
# train_task <- normalizeFeatures(train_task, method="standardize")
# test_task <- normalizeFeatures(train_task, method="standardize")
# train_task <- dropFeatures(task=train_task, features=c("EmpId", "StandHours"))

```

```{r glm}

drop <- c("EmpCount", "EmpID", "Over18", "StandHours")
employee_factor <- employee_factor[ , !(names(employee_factor) %in% drop)]

set.seed(307)
train_rows <- createDataPartition(y=employee_factor$Attrition, p=0.7, list=F)
train_subset <- employee_factor[train_rows,]
test_subset <- employee_factor[-train_rows,]

employee_glm <- glm(Attrition~., data=employee_factor, family="binomial")
summary(employee_glm)
imp <- as.data.frame(varImp(employee_glm))
imp <- data.frame(overall = imp$Overall, names=rownames(imp))
imp[order(imp$overall, decreasing=T),]

train_glm <- glm(Attrition~., data=train_subset, family="binomial")
summary(train_glm)
imp <- as.data.frame(varImp(train_glm))
imp <- data.frame(overall = imp$Overall, names=rownames(imp))
imp[order(imp$overall, decreasing=T),]

prob <- predict(train_glm, test_subset, type="response")
test_subset$Pred <- ifelse(prob > 0.141, "Yes", "No")
mean(test_subset$Pred == test_subset$Attrition)



```

```{r stepwise}

employee_null <- glm(Attrition ~ 1, data=employee_factor, family="binomial")
employee_full <- glm(Attrition ~ ., data=employee_factor, family="binomial")
employee_step <- step(employee_null, scope=list(lower=employee_null, upper=employee_full), direction="forward")
step_prob <- predict(employee_step, type="response")

```

Top via AIC: YrsAtcomp (603.37), YrsCurrRole (604.13), MnthRate (604.18), PerfRating (604.25), Age (604.51)
Invalidate the above. Need to change to using version of employee_factor with certain variables dropped.

```{r decision_trees}

employee_rf <- randomForest(Attrition ~ ., data=train_subset, ntree=500, mtry=sqrt(ncol(train_subset)))
summary(employee_rf)
plot(employee_rf)
print(employee_rf)

```

## 4d. Life Satisfaction

One final question of interest posed is whether life satisfaction can be related to this data set. None of the original 35 variables directly address life satisfaction (i.e., the employees were not explicitly asked to rate life satisfaction). Furthermore, criteria for life satisfaction likely varies between employees and some may not even be captured by any of the available variables (e.g., quality of relationships with family and friends, status of physical and mental health, etc). Therefore, the following analysis using the original data set is purely speculative. 

The three variables containing "satisfaction" in their name (Environment Satisfaction, Job Satisfaction, and Relationship Satisfaction) provide a reasonable starting point. Work Life Balance also seems sound. Incidentally, these are all variables in which employees were asked to rate their feelings on a scale of 1 to 4.

If career success were a major contributor to life satisfaction, several of the available variables may be useful. Education, Job Level, Monthly Income, and Total Working Years may capture some general job progression.

```{r life-satisfaction1, message=F, results="hide", warning=F}

# satisfy_var <- c("Age", "Attrition", "BusTravel", "EnvironSat", "JobInvolvemt", "JobSat", "MaritalStat", "MnthInc", "RelationSat", "TotalWrkYrs", "WorkLifeBal")
# employee_satisfaction <- employee_factor[ , (names(employee_factor) %in% satisfy_var)]
# dist_matrix <- dist(employee_satisfaction)
# employee_hclust <- hclust(d = dist_matrix)
# cutree(employee_hclust, h=6)
# plot(employee_hclust)

```

```{r life-satisfaction2}

# Collect variables used to calculate life satisfaction. Then, aggregate them to create Life Satisfaction variable.
satisfaction <- c("EnvironSat", "JobSat", "RelationSat", "WorkLifeBal")
employee_numeric$LifeSat <- rowMeans(employee_numeric[ , satisfaction])


ggplot(employee_numeric, aes(x=Age, y=LifeSat)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") + ylab("Life Satisfaction") + ggtitle("Life Satisfaction Tester") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)

ggplot(employee_numeric, aes(x=MnthInc, y=LifeSat)) +
  geom_point(alpha=0.3) +
  xlab("Monthly Income") + ylab("Life Satisfaction") + ggtitle("Life Satisfaction Tester") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)

```



# Conclusion

* Identify three factors contributing to turnover.
```{r prediction}
#ourPredict(employee)
```
* Identify any existing job-specific trends.
* Other considerations, such as next steps or other variables needed.
