---
title: "Analysis"
author: "Lavonnia Newman, Jeff Washburn, & Joseph Caguioa"
date: "2/25/2019"
output: 
  html_document:
    theme: default
    highlight: tango
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false

---

```{r setup, include=T, message=F, results="hide", warning=F}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)

# Packages used.
package_list <- c("tidyverse", "readxl", "knitr", "mlr", "kableExtra", "corrplot", "ggmosaic", "magrittr", "caret", "randomForest", "reshape", "gridExtra", "GGally", "purrr", "cowplot", "rpart", "rpart.plot", "leaps", "plyr", "grid")
lapply(package_list, library, character.only=T)

theme_set(theme_bw())

# Reusable colors for attrition.
attcol <- c("No"="seagreen3", "Yes"="indianred3")
# Reusable Likert scale colors.
likert <- c("1"="indianred3", "2"="bisque1", "3"="olivedrab3", "4"="springgreen3")
# Distinct colors, borrowed from https://sashat.me/2017/01/11/list-of-20-simple-distinct-colors/
hardcolors <- c("#E6194B", "#3CB44B", "#FFE119", "#4363D8", "#F58231", "#911EB4", "#42D4F4", "#F032E6", "#BFEF45")
softcolors <- c("#469990", "#E6BEFF", "#FF496D", "#98F5FF", "#FFFAC8", "#AAFFC3", "#FFD8B1", "#808000", "#9A6324")

# Reused function in tables to clean up outputs on mean.
SimpleMean <- function(var) {
  round(mean(var),2)
}

# Function that produces ggplot boxplots. Takes nominal groups on x-axis. Prefers continuous variable on y-axis.
ContVsNomBoxplots <- function(df, xvar="groups", yvar="continuous") {
  ggplot(df, aes_string(x=xvar, y=yvar, group=xvar, fill=xvar)) +
    geom_boxplot() +
    scale_fill_manual(values=hardcolors) +
    stat_summary(fun.y=mean, color="black", geom="point", shape=5, size=2) +
    guides(fill=guide_legend(title.position="top", title.hjust=0.5, ncol=2, byrow=F)) +
    theme(axis.text.x=element_blank(),
          axis.text.y=element_text(size=6),
          axis.ticks=element_blank(),
          axis.title=element_blank(),
          legend.key.size=unit(1,"line"),
          legend.position="bottom",
          legend.text=element_text(size=5),
          legend.title=element_text(size=6),
          plot.title = element_text(hjust = 0.5, size=8))
}

# Function that produces ggplot density plots. Takes continuous variable on x-axis. Intended for group as color.
ContDensity <- function(df, xvar="cont", yvar="groups") {
  ggplot(df, aes_string(x=xvar, color=yvar)) +
    geom_density(alpha=0.3) +
    scale_color_manual(values=attcol) +
    guides(fill=guide_legend(title.position="top", title.hjust=0.5)) +
    theme(axis.text.x=element_text(size=6),
          axis.text.y=element_blank(),
          axis.ticks=element_blank(),
          axis.title=element_blank(),
          legend.key.size=unit(1,"line"),
          legend.position="bottom",
          legend.text=element_text(size=5),
          legend.title=element_text(size=6),
          plot.title = element_text(hjust = 0.5, size=8))
}

# Function that produces ggplot jittered scatter plots. Intended continuous variable on x-axis, discrete variable on y-axis, grouping variable for color.
DiscVsContScatter <- function(df, xvar="cont", yvar="disc", groupvar="group") {
  ggplot(df, aes_string(x=xvar, y=yvar, color=groupvar)) +
    geom_jitter(alpha=0.3, width=0.1) +
    theme(axis.ticks=element_blank(),
          plot.title=element_text(hjust=0.5)) +
    geom_smooth(method="lm", se=T, level=0.95)
}

```

# Introduction

DDSAnalytics provides talent management solutions for Fortune 1000 companies. For these highly influential and competitive American companies, employee retention is critical for productivity, morale, and the bottom line. Therefore, identifying factors that could possibly predict employee turnover and then developing appropriate retention strategies is of great interest.

Our team of data scientists will analyze an existing data set of employee survey responses to identify major factors that contributed to attrition. Additionally, we will also point out other interesting trends that may provide insights for future development and retention strategies.

# 2. Load/Clean Data

```{r load1}

# Read in data set. [#2A]
employee <- read_excel('Data/DDSAnalytics_Data.xlsx', sheet = "HR-employee-attrition Data")

# Obtain dimensions. [#2A]
dim(employee)

```

The original data set provided by DDSAnalytics contains observations on 1,470 employees with information on 35 variables. In other words, the data set comprises a data frame of 1,470 rows and 35 columns. Whether this data comes from one company or multiple is unspecified.

```{r load2, message=F, warning=F}

# Modify column names. All names less than 12 characters, as requested. [#2B]
renamed <- read_excel('Data/VariableNames.xlsx')
colnames(employee) <- renamed$`Modified_Name`

# Convert column types. [#2D]
# Create data frame where all factor-type variables are converted accordingly.
employee_factor <- data.frame(employee)
employee_factor <- employee_factor %>% mutate_if(is.character, as.factor)
factor_cols <- c("EmpCount","StandHours")
employee_factor %<>% mutate_each(funs(factor(.)), factor_cols)

# Create data frame where all variables are numeric.
employee_numeric <- data.frame(employee_factor)
employee_numeric %<>% mutate_if(is.factor, as.numeric)

```

Two versions of the original employee data frame are created. One converts all character variables to factors. The other goes a step further and coerces all variables to numeric. Both are used in different ways during the analysis.

```{r eda-plots1, message=F, warning=F}

# Exploratory histograms of continuous variables.
employee_factor %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot(aes(value), fill=Attrition) +
    facet_wrap(~ key, scales="free") +
    geom_histogram() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))

```

Quick exploratory plots of all 35 variables on all of the data reveal some useful tidbits right off the bat. The histogram shapes alone show some interesting trends.

* Distance From Home, Percent Salary Increase, Total Working Years, Years At Company, Years In Current Role, Years Since Last Promotion, and Years With Current Manager have similar positively skewed distributions with long right tails. Some of these variables are likely correlated with each other.
    * A spike exists for year 6 in Years In Current Role (and by extension, likely correlated variables Years With Current Manager and Years At Company), potentially indicating a large influx of employees that year who are still with the company.
* Employee ID has a maximum value above 2000. The data set contains only 1,470 observations, meaning this may be a subset where other employee data has already been removed.
* Environment Satisfacion, Job Satisfaction, and Relationship Satisfaction have noticeable proportions of dissatisfied employees (where a score of 1 indicates low satisfaction).
* Job Level for most employees is 1 or 2.
* Performance Rating, defined on a scale of 1 to 4, only has scores of 3 and 4 represented.

```{r eda-plots2, message=F, warning=F}

# Exploratory bar graphs of factor variables.
employee_factor %>%
  keep(is.factor) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales="free") +
    geom_bar() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))

```

The exploratory bar graphs are similarly informative.

* Department shows that most employees are in Research & Development, followed by Sales. On a related note, Job Role shows most employees are Sales Executives, Research Scientists, or Laboratory Technicians; Education Field shows most have a background in Life Sciences or Medical.
* Employee Count is 1 for all employees in the data set because each row corresponds to answers for only one employee.
* Over 18 is Yes for all employees (including employees who are 18 years old).
* Standard Hours is 80 for all employees in the data set. Assuming a standard 40-hour workweek, all of the represented companies use bi-weekly paychecks.

```{r na}

# Has the Qualtrics system introduced any errors? [#2C]
colSums(is.na(employee_factor))

```

None of the quick graphs above threw any errors indicating that missing values were removed before plotting. There are no NA values for any variable. Furthermore, there are no outliers or unusual observations that could indicate entry errors. It seems reasonable to proceed with the assumption that the data set is correct and relatively clean.

```{r drop}

# Remove <18-year-olds. [#3A]
count(employee, "Over18")

# Remove unnecessary variables.
drop <- c("EmpCount", "EmpId", "Over18", "StandHours")
employee_factor <- employee_factor[ , !(names(employee_factor) %in% drop)]
employee_numeric <- employee_numeric[ , !(names(employee_numeric) %in% drop)]

```

As shown in a bar graph above, the Over 18 variable indicates that all employees are at least 18 years old. Furthermore, its total count matches the total number of observations. The minimum age (shown below), 18, confirms that there are no underage employees in the data set.

Before proceeding further, any variables with no variation (Employee Count, Over 18, and Standard Hours) can be removed because they have no useful information for predictive modeling. Employee ID can also be removed because observations can be tracked by other means. This results in a data frame of 1,470 rows and 31 columns.

# 3. Preliminary Analysis

## 3b. Descriptive stats

The following 2 tables show the descriptive statistics for 7 of the variables:

+ Age
+ Monthly Income (MnthInc)
+ Percent Salary Increase (PcntSalInc)
+ Years at Company (YrsAtComp)
+ Years at Current Role (YrsCurrRole)
+ Years Since Promotion (YrsSncPromo)
+ Years with Current Manager (YrsWtCurMgr)

```{r descriptive,echo=TRUE}
# Descriptive statistics (7) and histograms (2) for interesting variables. [#3B]
# Age, MnthInc, PcntSalInc, YrsAtComp, YrsCurrRole, YrsSncPromo, YrsWtCurMgr

descriptiveStats1 = employee[c("Age", "MnthInc", "PcntSalInc", "YrsAtComp")]

descriptiveStats2 = employee[c("YrsCurrRole", "YrsSncPromo", "YrsWtCurMgr")]

kable(summary(descriptiveStats1), col.names=c("Age", "Monthly Income", "% Salary Increase", 
                                              "Years at Company")) %>%   
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

kable(summary(descriptiveStats2), col.names=c("Years at Current Role", "Years Since Promotion", 
                                              "Years with Current Manager")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

The followng is a histrogram showing the distribution of Age in the company.  Overlayed on top of the histogram is the density curve and can see that the ages are a bit right tailed distributed with a lot of the workforce between 29 and 35 - a relatively young workforce.

```{r echo=T}
# Histogram - age
# 
summary(employee$Age)
ggAge = ggplot(employee, aes(Age))
ggAge = ggAge +geom_histogram(breaks=seq(18, 60, by=2), col="black", aes(fill=..count.., y=..density..)) 
ggAge = ggAge +scale_fill_gradient("Count", low="green", high="red")
ggAge = ggAge +geom_density(col="blue")
ggAge = ggAge +labs(title="Histogram for Age", x="Age", y="Density")
ggAge
```

The following is a histrogram of Monthly Income in the company with an overlay of the density curve showing the distribution of income.  The distribution appears to be right skewed with around 300 employees making around $2000 per month.

```{r, echo=T}
# Histogram - Income
summary(employee$MnthInc)
ggIncome = ggplot(employee, aes(MnthInc))
ggIncome = ggIncome +geom_histogram(breaks=seq(1000, 22000, by=1000), col="black", aes(fill=..count.., y=..density..))
ggIncome = ggIncome +scale_fill_gradient("Count", low="green", high="red")
ggIncome = ggIncome +geom_density(col="blue")
ggIncome = ggIncome +labs(title="Histogram for Income", x="Income", y="Density")
ggIncome
```

## 3c. Frequencies on Gender, Education, Occupation

The table command is used to count the employee data by a specified field type. The gender table shows that 60% of the employees are male in this database.   The education level shows that the highest concentration employees have Bachelor degree follow closely by the Master's degree.   These two positions account for 68% of the overall employee database.

```{r frequencies}

GenderData<- table(employee$Gender)
kable(GenderData,
      col.names = c("Gender",
                    "Count"),
      row.names = T,
      caption="Headcount By Gender",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


EducationData <- table(employee$Education)
names(EducationData)<-c("Below College", "College", "Bachelor", "Master", "Doctor")
kable(EducationData,
      col.names = c("Education Level", "Count"),
      row.names = T,
      caption="Headcount by Education",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

JobRoleData <- table(employee$JobRole)
kable(JobRoleData,
      col.names = c("Job Role",
                    "Count"),
      row.names = T,
      caption="Headcount By Job Role",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## 3d. Counts of Management positions

Our analysis of the data did not base management positions solely on the job grade.  Two tracks for promotion include the individual contributor and management track.   The management track in our analysis includes positions in which employee line management would exist.   Manager, Manufacturing Director and the Research Director would fall into that category. Using this definition 22% of the positions are management.  All of other positions were not considered as management.

```{r management}

managerRoles<-c("Manager", "Manufacturing Director", "Research Director")
ManagerRoleData<- employee[employee$JobRole %in% managerRoles, ]
ManagerRoleData <- data.frame(table(ManagerRoleData$JobRole))
names(ManagerRoleData) <- c("JobRoles", "Count")
kable(ManagerRoleData,
      col.names = c("Job Role", "Count"),
      row.names = T,
      caption="Headcount by Manager Role",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

# 4. Deep Analysis

## Correlation

DDSAnalytics' main question of interest with this data set is to identify factors contributing to turnover, but other trends in the data may also be useful. Therefore, a visualization that shows how the variables correlate with each other is a good starting point for analysis.

``` {r correlations1, warning=F}

# Show correlating variables for further investigation.
# corrplot(cor(employee_numeric), type = "upper", tl.col = "black", tl.srt = 45, tl.cex = 0.5, number.cex = 0.3, method="number")

corrplot(cor(employee_numeric), type = "upper", tl.col = "black", tl.srt = 45, tl.cex = 0.5, number.cex = 0.3, number.digits=2, method="color", addCoef.col="white")

```

The above correlogram requires the fully numeric version of the data frame. Any correlations involving a categorical variable with no intrinsic order, such as the strong negative correlation between Marital Status and Stock Option Level, requires more investigation to determine whether the correlation is meaningful or just a byproduct of the numeric coercion. In this plot, stronger colors (that allow viewing of the white text) are associated with stronger correlations. Hence, the diagonal of each variable against itself is dark blue with the expected Pearson's r of 1.

Some of the following relationships stand out on a cursory exploration:

* Age, Job Level, Monthly Income, Total Working Years, Years At Company, Years In Current Role, Years Since Last Promotion, and Years With Current Manager all show moderate to strong positive correlations with each other. This makes intuitive sense, as an older person with a longer career is more likely to hold higher positions and wield more earning potential. (Age and Monthly Income specifically are further explored in the Age and Income section.) By itself, Age also has weaker positive correlations with amount of Education and Number of Companies Worked.
* Department and Job Role show a strong positive correlation. Though both are categorical variables, the organization within both happens to line up such that numbers for related levels trend together, such as Sales Representatives in the Sales department. This is further explored in the Job-Specific Trends section.
* Hourly Rate, Daily Rate, Monthly Rate, and Monthly Income do not show any correlation. This finding is somewhat unexpected, as one would expect these monetary variables to show some sort of relationship. This is further explored in the Rates & Income section.
* Performance Rating and Percent Salary Increase show a strong positive correlation; those who perform the best are likely given the biggest pay raises. Sure enough, only employees who reported an Oustanding performance rating (4 out of 4) were rewarded with raises above 20%, as shown below.

```{r performance-payraise}

ggplot(employee_factor, aes(x=PcntSalInc, y=PerfRating)) + 
  geom_point(alpha=0.1, size=3) +
  scale_x_continuous(breaks=seq(10,25, by=5)) +
  scale_y_continuous(breaks=seq(3,4, by=1)) +
  xlab("Percent Salary Increase") +
  ylab("Performance Rating")

```

Individual correlations between Attrition and other variables are relatively weak. Of these, Overtime, Monthly Income, Job Level, and any of the variables related to career length (e.g., Age, Total Working Years) look the most promising. This is further explored in the Predicting Attrition section.

## Rates & Income

The data set contains four variables related to money: Hourly Rate, Daily Rate, Monthly Rate, and Monthly Income. Their data definitions are not well-defined, but it can be reasonably assumed that the "Rate" variables relate to wages earned over the indicated unit of time and the "Income" variable translates to monthly take-home pay. If this were the case, it should be feasible to build a model to describe the relationship between them.

```{r rate-income1, message=F, warning=F}

# Visualize relationship between rates and income. Unable to apply custom attrition palette to ggpairs.
ggpairs(employee_factor, aes(color=Attrition, alpha=0.1), 
        columns=c("HourlyRate", "DailyRate", "MnthRate", "MnthInc"),
        title="Correlation Matrix for Monetary Variables and Attrition",
        axisLabels="none",
        upper=list(continuous=wrap("cor", size=3, hjust=0.8)))

```

Scatterplots of the rates and income variables against each other do not show any discernible relationship; the correlation values, being near zero, would suggest that no relationship exists at all, supporting the earlier observation made about the correlogram. This is an unexpected result, as one would reasonably expect that these variables would trend together. Perhaps another variable not captured by the data, or the survey method by which the data was collected from employees, is responsible.

Another oddity reveals itself when we compare the minimum and maximum values for each variable.

```{r rate-income2}

# Divide data based on which of Monthly Income and Rate is greater.
MnthIncGreater <- summary(employee_factor[which(employee_factor$MnthRate < employee_factor$MnthInc), ])
MnthRateGreater <- summary(employee_factor[which(employee_factor$MnthRate > employee_factor$MnthInc), ])

# Display lower and upper bounds for each category.
employee_money <- data.frame(
  rbind(c(min(employee_numeric$HourlyRate), max(employee_numeric$HourlyRate)),
        c(min(employee_numeric$DailyRate), max(employee_numeric$DailyRate)),
        c(min(employee_numeric$MnthRate), max(employee_numeric$MnthRate)),
        c(min(employee_numeric$MnthInc), max(employee_numeric$MnthInc))))
row.names(employee_money) <- c("Hourly Rate", "Daily Rate", "Monthly Rate", "Monthly Income")
colnames(employee_money) <- c("Minimum", "Maximum")

kable(employee_money,
      col.names = c("Minimum", "Maximum"),
      row.names = T,
      caption="Rates & Income Bounds",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

For all observations, Monthly Rate is greater than Daily Rate, which in turn is greater than Hourly Rate. This is expected. However, Monthly Rate is greater than Monthly Income for only `r round(mean(employee_numeric$MnthRate > employee_numeric$MnthInc) * 100, digits=2)`% of the observations; in other words, 258 of the 1,470 employees reported a greater Monthly Income than Monthly Rate. Assuming the above interpretation of rate as pre-deduction and income as post-deduction earnings is accurate, why might this be? Investigating the reason for these strange trends is recommended.

## 4c. Age and Income

Analyzing the potential relationship between Age and income is another of DDSAnalytics' questions of interest. Considering the earlier exploratory histograms and our assumed definitions, we use the Monthly Income variable over working with any of the rates.

```{r age-income1}

# Scatterplot on Age, Monthly Income, and Gender. [#4C]
ggplot(employee_factor, aes(x=Age, y=MnthInc, color=Gender)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income Rises with Age") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)

# Obtain linear model, show residual diagnostics and coefficients.
lm1 <- lm(MnthInc ~ Age, employee_factor)
par(mfrow=c(2,2))
plot(lm1)
summary(lm1)

```

A moderate positive correlation exists between Age and Monthly Income, with Pearson's r = `r cor(employee_factor$Age, employee_factor$MnthInc)`. Drawing a scatterplot between the two shows a general upward trend in income as Age increases, and the best-fitting regression line has a positive slope. 

However, an early exploratory histogram showed that Monthly Income is right-skewed, as is normal for salary distributions. Furthermore, residual diagnostic plots show possible violations against linear regression assumptions, particularly in heteroscedasticity (normality is taken care of by the Central Limit Theorem, as this is a large sample). We can attempt a log transformation to try to mitigate heteroscedasticity.

```{r age-income2}

# Log transform nonnormal numeric variables that do not have 0 as minimum.
employee_log <- data.frame(employee_factor)
employee_log$lDistFromHme <- log(employee_log$DistFromHme)
employee_log$lMnthInc <- log(employee_log$MnthInc)
employee_log$lPcntSalInc <- log(employee_log$PcntSalInc)
employee_log[, c("DistFromHme", "MnthInc", "PcntSalInc")] <- NULL

# Factorize appropriate variables.
factorize <- c("Education", "EnvironSat", "JobInvolvemt", "JobLevel", "JobSat", "PerfRating", "RelationSat", "StckOptLev", "WorkLifeBal")
employee_log %<>% mutate_each(funs(factor(.)), factorize)

# Scatterplot on Age, log(Monthly Income), and Gender.
ggplot(employee_log, aes(x=Age, y=lMnthInc, color=Gender)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") +
  ylab("log(Monthly Income)") +
  ggtitle("log(Monthly Income) Rises with Age") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = T,
              level = 0.95)

# Obtain log-linear model, show residual diagnostics and coefficients.
lm2 <- lm(lMnthInc ~ Age, employee_log)
par(mfrow=c(2,2))
plot(lm2)
summary(lm2)

```

The correlation for Age and log(Monthly Income) drops slightly from before, with Pearson's r = `r cor(employee_log$Age, employee_log$lMnthInc)`. However, the residual diagnostics look much better. 

In any case, there is a definite positive correlation between Age and Monthly Income, supporting the observation made from the correlogram. Linear and log-linear regression models can be created, indicating that mean or median Monthly Income can likely be predicted from Age. 

## Job-Specific Trends

Employees in this data set fall into nine different job roles. Do some trends apply to certain jobs more than others?

```{r jobrole-boxplots1, warning=F, message=F}

# Throwaway graph to obtain common job role legend.
jobrole_age_a <- ContVsNomBoxplots(employee_factor, "JobRole", "Age") +
  scale_fill_manual("Job Roles", values=hardcolors)
jobrole_legend <- get_legend(jobrole_age_a)

# Group 1 of job role boxplots.
# Job Role and Monthly Income boxplots.
jobrole_monthincome <- ContVsNomBoxplots(employee_factor, "JobRole", "MnthInc") + 
  ggtitle("Monthly Income") + theme(legend.position="none")
# Job Role and Percent Salary Increase boxplots.
jobrole_salaryincrease <- ContVsNomBoxplots(employee_factor, "JobRole", "PcntSalInc") +
  ggtitle("Percent Salary Increase") + theme(legend.position="none")
# Job Role and Distance From Home boxplots.
jobrole_distancehome <- ContVsNomBoxplots(employee_factor, "JobRole", "DistFromHme") +
  ggtitle("Distance From Home") + theme(legend.position="none")
# Job Role and Age boxplots.
jobrole_age <- ContVsNomBoxplots(employee_factor, "JobRole", "Age") +
  ggtitle("Age") + theme(legend.position="none")

# Arrange first set of job role boxplots with common legend. 
grid.arrange(jobrole_monthincome, jobrole_salaryincrease, jobrole_distancehome, jobrole_age, jobrole_legend, ncol=3)

```

On average and as a whole, managers and research directors are older and have a higher monthly income. In a similar vein, sales representatives are younger and make the least. Despite their title, manufacturing directors have a monthly income roughly on par with healthcare representatives and sales executives; these three groups have similar age distributions. Fittingly, these trends provide supporting evidence to the earlier exploration of the correlation between age and monthly income.

```{r jobrole-boxplots2}

# Grouping of boxplots involving years as the continuous variable.
# Job role and total working years boxplots.
jobrole_totalworkyears <- ContVsNomBoxplots(employee_factor, "JobRole", "TotalWrkYrs") +
  ggtitle("Total Work Years") + theme(legend.position="none")
# Job role and years in current role boxplots.
jobrole_currentyears <- ContVsNomBoxplots(employee_factor, "JobRole", "YrsCurrRole") +
  ggtitle("Years in Current Role") + theme(legend.position="none")
# Job role and years at current company boxplots.
jobrole_yearsatcomp <- ContVsNomBoxplots(employee_factor, "JobRole", "YrsAtComp") +
  ggtitle("Years at Current Company") + theme(legend.position="none")
# Job role and years with current manager boxplots.
jobrole_currentmanager <- ContVsNomBoxplots(employee_factor, "JobRole", "YrsWtCurMgr") +
  ggtitle("Years with Current Manager") + theme(legend.position="none")
# Job role and number of companies worked boxplots.
jobrole_numcompanies <- ContVsNomBoxplots(employee_factor, "JobRole", "NumCoWorked") +
  ggtitle("Number of Companies Worked") + theme(legend.position="none") + scale_y_continuous(breaks=seq(0,10, by=2))

# Arrange remaining job role boxplots related to years with common legend.
grid.arrange(jobrole_totalworkyears, jobrole_currentyears, jobrole_yearsatcomp, jobrole_currentmanager, jobrole_numcompanies, jobrole_legend, ncol=3)

```

Perhaps correlated with their age and contributing to their higher monthly income, managers and reserach directors also, as a whole, have the most experience in work years and the longest stays with the company in their present role. Additionally, research directors have, on average, worked at more companies during their career; it's reasonable to assume that they are being well-compensated for their expertise.

On the flipside, young sales representatives also stand out for being early in their careers, with the lowest total working years and years with the company as a group.

```{r jobrole-table}

# Table summarizing interval variables by job role.
ddply(employee_factor, .(JobRole), summarize,
      Education=SimpleMean(Education),
      EnvironSat=SimpleMean(EnvironSat),
      JobInvolvemt=SimpleMean(JobInvolvemt),
      JobLevel=SimpleMean(JobLevel),
      JobSat=SimpleMean(JobSat),
      PerfRating=SimpleMean(PerfRating),
      RelationSat=SimpleMean(RelationSat),
      StckOptLevel=SimpleMean(StckOptLev),
      WorkLifeBal=SimpleMean(WorkLifeBal)) %>%
  kable(caption="Job Roles: Means for Interval Variables", align="c",
        col.names=c("Job Role", "Education", "Environment Satisfaction", "Job Involvement", "Job Level", "Job Satisfaction", "Performance Rating", "Relationship Satisfaction", "Stock Option Level", "Work Life Balance")) %>% 
  kable_styling(bootstrap_options=c("striped", "hover", "condensed"), font_size=7)

```

* Research directors, managers, and sales executives are the most well-educated. Average employees in these roles have at least a bachelors degree.
* Managers and research directors have the highest average job level, to which their monthly incomes are likely commensurate.
* Human resources roles report the highest work-life balance and satisfaction in their relationships, but the lowest job satisfaction.
* Sales representatives are the least educated and hold the lowest-level jobs. They report the lowest job involvement and second-highest work-life balance, yet the lowest relationship satisfaction.

```{r jobrole-barplots1, message=F, warning=F}

# Reusable theme elements common across stacked barplots.
clean_bar_theme <- theme(axis.text=element_text(size=7),
                         axis.title.x=element_text(size=8),
                         axis.title.y=element_blank(),
                         axis.ticks=element_blank(),
                         legend.justification="left",
                         legend.key.size=unit(0.2, "cm"),
                         legend.text=element_text(size=5),
                         legend.title=element_text(size=10),
                         legend.position="top",
                         plot.margin=unit(c(0,1,0.5,0.5),units="line"),
                         plot.title=element_text(size=7))

# Unable to abstract function call to table.
# Job Role and Attrition bar graphs.
job_attrition <- data.frame(with(employee_factor, table(JobRole, Attrition))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=Attrition)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  #geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Attrition", values=attcol) +
  guides(fill=guide_legend(title.position="left", ncol=1)) +
  clean_bar_theme

# Job Role and Business Travel bar graphs.
job_travel <- data.frame(with(employee_factor, table(JobRole, BusTravel))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=BusTravel)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  #geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Business Travel", values=softcolors) +
  guides(fill=guide_legend(title.position="left", ncol=1)) +
  clean_bar_theme

# Job Role and Department bar graphs.
job_dept <- data.frame(with(employee_factor, table(JobRole, Department))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=Department)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  #geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Department", values=softcolors[4:6]) +
  guides(fill=guide_legend(title.position="left", ncol=1)) +
  clean_bar_theme

# Job Role and Education Field bar graphs.
job_edufield <- data.frame(with(employee_factor, table(JobRole, EduField))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=EduField)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  #geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Education Field", values=softcolors[1:6]) +
  guides(fill=guide_legend(title.position="left", ncol=1)) +
  clean_bar_theme

# Job Role and Gender bar graphs.
job_gender <- data.frame(with(employee_factor, table(JobRole, Gender))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=Gender)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  #geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  guides(fill=guide_legend(title.position="left", ncol=1)) +
  clean_bar_theme

# Job Role and Marital Status bar graphs.
job_marital <- data.frame(with(employee_factor, table(JobRole, MaritalStat))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=MaritalStat)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  #geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Marital Status", values=softcolors[7:9]) +
  guides(fill=guide_legend(title.position="left", ncol=1)) +
  clean_bar_theme

# Job Role and Overtime bar graphs.
job_overtime <- data.frame(with(employee_factor, table(JobRole, Overtime))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=Overtime)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  #geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Overtime", values=attcol) +
  guides(fill=guide_legend(title.position="left", ncol=1)) +
  clean_bar_theme

# Output plots separately to allow for height expansion.
grid.arrange(job_attrition, job_travel, job_dept, job_edufield, ncol=2)
grid.arrange(job_gender, job_marital, job_overtime, ncol=2)

```

```{r jobrole-barplots2}

# Percentage within Job Role for Attrition and Overtime.
job_att_percent_bar <- employee_factor %>%
  group_by(JobRole, Attrition) %>%
  dplyr::summarise(n=n()) %>%
  dplyr::mutate(freq=round(100*n/sum(n),2)) %>%
  subset(Attrition=="Yes") %>%
  ggplot(aes(x=reorder(JobRole, freq), y=freq)) +
  geom_bar(stat="identity", aes(fill=JobRole)) +
  coord_flip() +
  scale_fill_manual(values=hardcolors) +
  geom_text(aes(x=JobRole, y=freq, group=freq, label=paste0(freq,"%")), size=2, hjust=1) +
  ggtitle("Attrition Percentage By Job Role") +
  theme(axis.text=element_text(size=7),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))
job_ot_percent_bar <- employee_factor %>%
  group_by(JobRole, Overtime) %>%
  dplyr::summarise(n=n()) %>%
  dplyr::mutate(freq=round(100*n/sum(n),2)) %>%
  subset(Overtime=="Yes") %>%
  ggplot(aes(x=reorder(JobRole, freq), y=freq)) +
  geom_bar(stat="identity", aes(fill=JobRole)) +
  coord_flip() +
  scale_fill_manual(values=hardcolors) +
  geom_text(aes(x=JobRole, y=freq, group=freq, label=paste0(freq,"%")), size=2, hjust=1) +
  ggtitle("Overtime Percentage By Job Role") +
  theme(axis.text=element_text(size=7),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))
grid.arrange(job_att_percent_bar, job_ot_percent_bar, ncol=2)

```

* Management positions (manager, manufacturing director, research director) are among those with the lowest attrition rates. Aside from healthcare representative, all other roles have attrition rates near or exceeding the sample's 16.12%.
* Human resources personnel and some managers (codified as levels 2 and 4 of Job Role) are in Human Resources (codified as level 1 of Department). Some managers, plus all sales executives and sales representatives (levels 4, 8, and 9, of Job Role) are in Sales (level 3 of Department). Some managers, plus the remaining jobs (levels 1 and 3-7) are in Research & Development (level 2 of Department). In other words, factor numbers for Job Role generally correlate with factor numbers for Department, explaining the observation from the correlogram.
* Within most roles, the gender ratio is relatively proportionate to the Male:Female ratio (60:40) in the dataset. The biggest deviations in either direction are managers (nearly 50:50) and human resources (70:30).
* Sales representatives (45.78%) have the highest percentage of singles. Research directors (28.75%), manufacturing directors (27.48%), and healthcare representatives (25.95%) have the highest divorce rates.
* For the sample overall, the rate of employees who work Overtime is 28.3%. Research scientists, who reported the highest mean Job Involvement, also have the highest Overtime ratio.

## Predicting Attrition

```{r attrition-pie, fig.width=3, fig.height=3}

# Pie graph with ggplot.
ggplot(employee_factor, aes(x="", y="", fill=Attrition)) +
  geom_bar(width=1, stat="identity") +
  coord_polar("y", start=0) +
  scale_fill_manual(values=attcol) +
  theme_minimal() +
  theme(axis.title=element_blank(),
        panel.border=element_blank(),
        panel.grid=element_blank(),
        axis.ticks=element_blank())

```

In this data set `r round(mean(employee_factor$Attrition=="Yes")*100, digits=2)`%, or `r sum(employee_factor$Attrition=="Yes")` of the 1470 employees attrited. Analyzing statistics and plots can help develop the profile of the type of employee who left, especially compared to those who stayed.

### Developing the Profile

```{r attrition-table1, include=F, results="hide", fig.show="hide"}

# Different table of statistics favored. Code saved for reuse.
# # Subset data and retrieve summary statistics on employees who attrited.
# attrited_summary <- data.frame(do.call('rbind', lapply(attrited, function(x) if(is.numeric(x)) round(summary(x),2))))
# attrited_summary$Mean <- round(attrited_summary$Mean, digits=2)
# colnames(attrited_summary) <- c("Minimum", "1st Quartile", "Median", "Mean", "3rd Quartile", "Maximum")
# kable(attrited_summary, row.names = T,
#       caption = "Summary Statistics of People Who Left", 
#       table.attr="style='width:90%;'") %>%
#   kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

```{r attrition-table2}

# Compare mean values by Attrition.
t(ddply(employee_factor, .(Attrition), summarize,
        "Age"=SimpleMean(Age),
        "Distance From Home"=SimpleMean(DistFromHme),
        "Education"=SimpleMean(Education),
        "Environment Satisfaction"=SimpleMean(EnvironSat),
        "Job Involvement"=SimpleMean(JobInvolvemt),
        "Job Level"=SimpleMean(JobLevel),
        "Job Satisfaction"=SimpleMean(JobSat),
        "Monthly Income"=SimpleMean(MnthInc),
        "Number of Companies Worked"=SimpleMean(NumCoWorked),
        "Percent Salary Increase"=SimpleMean(PcntSalInc),
        "Performance Rating"=SimpleMean(PerfRating),
        "Relationship Satisfaction"=SimpleMean(RelationSat),
        "Stock Option Level"=SimpleMean(StckOptLev),
        "Total Working Years"=SimpleMean(TotalWrkYrs),
        "Training Times Last Year"=SimpleMean(TrainPrevYr),
        "Work Life Balance"=SimpleMean(WorkLifeBal),
        "Years At Company"=SimpleMean(YrsAtComp),
        "Years In Current Role"=SimpleMean(YrsCurrRole),
        "Years Since Last Promotion"=SimpleMean(YrsSncPromo),
        "Years With Current Manager"=SimpleMean(YrsWtCurMgr))) %>%
  kable(caption="Attrition: Means for Numeric Variables", align="c",
        table.attr="style='width:50%;'") %>%
  row_spec(row=1, bold=T, background="#7D7D7D", color="white") %>%
  kable_styling(bootstrap_options=c("striped", "hover", "condensed"), font_size=8)

```

```{r attrition-density}

# Throwaway graph to obtain common Attrition legend.
att_age_a <- ContDensity(employee_factor, "Age", "Attrition")
attrition_legend <- get_legend(att_age_a)

# Attrition and Age density plot.
att_age <- ContDensity(employee_factor, "Age", "Attrition") +
  ggtitle("Age") + theme(legend.position="none")
# Attrition and Distance From Home density plot.
att_distance <- ContDensity(employee_factor, "DistFromHme", "Attrition") +
  ggtitle("Distance From Home") + theme(legend.position="none")
# Attrition and Monthly Income density plot.
att_monthlyincome <- ContDensity(employee_factor, "MnthInc", "Attrition") +
  ggtitle("Monthly Income") + theme(legend.position="none")
# Attrition and Percent Salary Increase density plot.
att_salaryincrease <- ContDensity(employee_factor, "PcntSalInc", "Attrition") +
  ggtitle("Percent Salary Increase") + theme(legend.position="none")
# Attrition and Number of Companies Worked density plot.
att_numcompanies <- ContDensity(employee_factor, "NumCoWorked", "Attrition") +
  ggtitle("Number of Companies Worked") + theme(legend.position="none")
# Attrition and Total Working Years density plot.
att_totalyears <- ContDensity(employee_factor, "TotalWrkYrs", "Attrition") +
  ggtitle("Total Working Years") + theme(legend.position="none")
# Attrition and Training Times Last Year density plot.
att_trainprevyear <- ContDensity(employee_factor, "TrainPrevYr", "Attrition") +
  ggtitle("Training Times Last Year") + theme(legend.position="none")
# Attrition and Years at Company density plot.
att_yearscomp <- ContDensity(employee_factor, "YrsAtComp", "Attrition") +
  ggtitle("Years At Company") + theme(legend.position="none")
# Attrition and Years In Current Role density plot.
att_yearsrole <- ContDensity(employee_factor, "YrsCurrRole", "Attrition") +
  ggtitle("Years In Current Role") + theme(legend.position="none")
# Attrition and Years Since Last Promotion density plot.
att_yearspromo <- ContDensity(employee_factor, "YrsSncPromo", "Attrition") +
  ggtitle("Years Since Last Promotion") + theme(legend.position="none")
# Attrition and Years With Current Manager density plot.
att_yearsmanager <- ContDensity(employee_factor, "YrsWtCurMgr", "Attrition") +
  ggtitle("Years With Current Manager") + theme(legend.position="none")

# Collectively output Attrition density plots to show distributions.
grid.arrange(att_age, att_distance, att_monthlyincome, att_salaryincrease, 
             att_numcompanies, att_totalyears, att_trainprevyear, att_yearscomp,
             att_yearsrole, att_yearspromo, att_yearsmanager, attrition_legend, 
             ncol=4, 
             top=textGrob("Attrition Density Distributions", 
                          gp=gpar(fontsize=20, fontface="bold")))

```

```{r attrition-barplots}

# Attrition and Business Travel barplots.
att_travel_count <- ggplot(employee_factor, aes(x=BusTravel, y=..count..)) +
  geom_bar(aes(fill=Attrition), position="dodge") +
  coord_flip() +
  ggtitle("Business Travel: Counts") +
  scale_fill_manual(values=attcol) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))
att_travel_rate <- employee_factor %>%
  group_by(BusTravel, Attrition) %>%
  dplyr::summarise(n=n()) %>%
  dplyr::mutate(freq=round(100*n/sum(n),2)) %>%
  subset(Attrition=="Yes") %>%
  ggplot(aes(x=reorder(BusTravel, freq), y=freq)) +
  geom_bar(stat="identity", aes(fill=BusTravel)) +
  coord_flip() +
  scale_fill_manual(values=softcolors) +
  geom_text(aes(x=BusTravel, y=freq, group=freq, label=paste0(freq,"%")), size=2, hjust=1) +
  ggtitle("Business Travel: Attrition Percentage") +
  theme(axis.text=element_text(size=7),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))

# Attrition and Department barplots.
att_dept_count <- ggplot(employee_factor, aes(x=Department, y=..count..)) +
  geom_bar(aes(fill=Attrition), position="dodge") +
  coord_flip() +
  ggtitle("Department: Counts") +
  scale_fill_manual(values=attcol) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))
att_dept_rate <- employee_factor %>%
  group_by(Department, Attrition) %>%
  dplyr::summarise(n=n()) %>%
  dplyr::mutate(freq=round(100*n/sum(n),2)) %>%
  subset(Attrition=="Yes") %>%
  ggplot(aes(x=reorder(Department, freq), y=freq)) +
  geom_bar(stat="identity", aes(fill=Department)) +
  coord_flip() +
  scale_fill_manual(values=softcolors[4:6]) +
  geom_text(aes(x=Department, y=freq, group=freq, label=paste0(freq,"%")), size=2, hjust=1) +
  ggtitle("Department: Attrition Percentage") +
  theme(axis.text=element_text(size=7),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))

# Attrition and Education Field barplots.
att_edufield_count <- ggplot(employee_factor, aes(x=EduField, y=..count..)) +
  geom_bar(aes(fill=Attrition), position="dodge") +
  coord_flip() +
  ggtitle("Education Field: Counts") +
  scale_fill_manual(values=attcol) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))
att_edufield_rate <- employee_factor %>%
  group_by(EduField, Attrition) %>%
  dplyr::summarise(n=n()) %>%
  dplyr::mutate(freq=round(100*n/sum(n),2)) %>%
  subset(Attrition=="Yes") %>%
  ggplot(aes(x=reorder(EduField, freq), y=freq)) +
  geom_bar(stat="identity", aes(fill=EduField)) +
  coord_flip() +
  scale_fill_manual(values=softcolors[1:6]) +
  geom_text(aes(x=EduField, y=freq, group=freq, label=paste0(freq,"%")), size=2, hjust=1) +
  ggtitle("Education Field: Attrition Percentage") +
  theme(axis.text=element_text(size=7),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))

# Attrition and Gender barplots.
att_gender_count <- ggplot(employee_factor, aes(x=Gender, y=..count..)) +
  geom_bar(aes(fill=Attrition), position="dodge") +
  coord_flip() +
  ggtitle("Gender: Counts") +
  scale_fill_manual(values=attcol) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))
att_gender_rate <- employee_factor %>%
  group_by(Gender, Attrition) %>%
  dplyr::summarise(n=n()) %>%
  dplyr::mutate(freq=round(100*n/sum(n),2)) %>%
  subset(Attrition=="Yes") %>%
  ggplot(aes(x=reorder(Gender, freq), y=freq)) +
  geom_bar(stat="identity", aes(fill=Gender)) +
  coord_flip() +
  geom_text(aes(x=Gender, y=freq, group=freq, label=paste0(freq,"%")), size=2, hjust=1) +
  ggtitle("Gender: Attrition Percentage") +
  theme(axis.text=element_text(size=7),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))

# Attrition and Marital Status barplots.
att_marital_count <- ggplot(employee_factor, aes(x=MaritalStat, y=..count..)) +
  geom_bar(aes(fill=Attrition), position="dodge") +
  coord_flip() +
  ggtitle("Marital Status: Counts") +
  scale_fill_manual(values=attcol) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))
att_marital_rate <- employee_factor %>%
  group_by(MaritalStat, Attrition) %>%
  dplyr::summarise(n=n()) %>%
  dplyr::mutate(freq=round(100*n/sum(n),2)) %>%
  subset(Attrition=="Yes") %>%
  ggplot(aes(x=reorder(MaritalStat, freq), y=freq)) +
  geom_bar(stat="identity", aes(fill=MaritalStat)) +
  coord_flip() +
  scale_fill_manual(values=softcolors[7:9]) +
  geom_text(aes(x=MaritalStat, y=freq, group=freq, label=paste0(freq,"%")), size=2, hjust=1) +
  ggtitle("Marital Status: Attrition Percentage") +
  theme(axis.text=element_text(size=7),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))

# Attrition and Overtime barplots.
att_overtime_count <- ggplot(employee_factor, aes(x=Overtime, y=..count..)) +
  geom_bar(aes(fill=Attrition), position="dodge") +
  coord_flip() +
  ggtitle("Overtime: Counts") +
  scale_fill_manual(values=attcol) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))
att_overtime_rate <- employee_factor %>%
  group_by(Overtime, Attrition) %>%
  dplyr::summarise(n=n()) %>%
  dplyr::mutate(freq=round(100*n/sum(n),2)) %>%
  subset(Attrition=="Yes") %>%
  ggplot(aes(x=reorder(Overtime, freq), y=freq)) +
  geom_bar(stat="identity", aes(fill=Overtime)) +
  coord_flip() +
  scale_fill_manual(values=attcol) +
  geom_text(aes(x=Overtime, y=freq, group=freq, label=paste0(freq,"%")), size=2, hjust=1) +
  ggtitle("Overtime: Attrition Percentage") +
  theme(axis.text=element_text(size=7),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        legend.position="none",
        plot.title=element_text(size=10))

# Output combinations of count barplots and percentage barplots. Separated to expand height.
grid.arrange(att_travel_count, att_travel_rate,
             att_dept_count, att_dept_rate,
             att_edufield_count, att_edufield_rate, ncol=2)
grid.arrange(att_gender_count, att_gender_rate,
             att_marital_count, att_marital_rate,
             att_overtime_count, att_overtime_rate,
             ncol=2)

```

From the averages, density distributions, and barplots, a general profile emerges on what the typical employee who leaves generally looks like compared to an employee who stays:

* Younger, single, less educated
* Holds lower job level with lower job involvement, lower stock option levels, and lower monthly income
* Lives further from work, travels for business, and works overtime
* Less satisfied with environment, job, and relationship; reports lower work-life balance
* Earlier in career, fewer years with company
* More likely to be in the human resources or sales departments; more likely to hold sales representative, laboratory technician, or human resources as job role

Of these factors, which are the biggest determinants for attrition, and is it possible to predict whether an employee will leave using them? 

### Building a Predictive Model

In each of the following models, the original data set is divided into training and testing subsets. We build a model based on the training data, and then see how accurately the model can predict known results in the testing data.

#### Logistic Regression

For a classification problem, logistic regression is a natural first model to try.

```{r attrition-glm}

# Replicable stratified sampling on attrition.
set.seed(123)
train_rows <- createDataPartition(y=employee_factor$Attrition, p=0.75, list=F)
train_subset <- employee_factor[train_rows,]
test_subset <- employee_factor[-train_rows,]

# Create models with no and all predictors as starting/endpoints for automatic variable selection.
null_model <- glm(Attrition~1, data=train_subset, family="binomial")
full_model <- glm(Attrition~., data=train_subset, family="binomial")

# Build stepwise regression model and classify based on mean probability.
set.seed(123)
glmStep_model <- step(null_model, scope=list(lower=null_model, upper=full_model), direction="both", trace=F)
glmStep_prob <- predict(glmStep_model, newdata=test_subset, type="response")
prediction_glmStep <- as.factor(ifelse(glmStep_prob > 0.16, "Yes", "No"))
confusionMatrix(prediction_glmStep, test_subset$Attrition, positive="Yes")

# View most important predictors for stepwise model.
glmStep_imp <- as.data.frame(varImp(glmStep_model))
glmStep_imp <- data.frame(Overall=glmStep_imp$Overall, Predictors=rownames(glmStep_imp))
glmStep_imp[order(glmStep_imp$Overall, decreasing=T),]

```

This first model is 77.93% accurate, with 71.19% sensitivity for detecting those who attrite. Of note, it reports that Overtime, Years Since Promotion, Job Satisfaction, and Number of Companies Worked are among the most important predictors.

However, this intial model is on the original, untransformed data. Histograms from the exploratory data analysis show that some variables are heavily right skewed, such as Monthly Income. To ensure that our linear regression model meets the normality assumption, we attempt to log transform the numeric variables where possible. Many variables regarding number of years contain zeros, which do not produce valid numbers when log transformed. These observations cannot be dropped because those employees are part of the target group we are trying to identify. Thus, we proceed with a select few variables transformed: Distance From Home, Monthly Income, and Percent Salary Increase. Additionally, we drop some of the "Years" variables that are highly correlated.

```{r attrition-glm-log}

# Remove collinear variables based on correlogram.
employee_log[, c("YrsCurrRole", "YrsSncPromo", "YrsWtCurMgr")] <- NULL

# Replicable stratified sampling on Attrition.
set.seed(123)
train_rows2 <- createDataPartition(y=employee_log$Attrition, p=0.75, list=F)
train_subset2 <- employee_log[train_rows2,]
test_subset2 <- employee_log[-train_rows2,]

# Create models with no and all predictors as starting/endpoints for automatic variable selection.
null_model2 <- glm(Attrition~1, data=train_subset2, family="binomial")
full_model2 <- glm(Attrition~., data=train_subset2, family="binomial")

# Build stepwise regression model and classify based on mean probability.
set.seed(123)
glmStep_model2 <- step(null_model2, scope=list(lower=null_model2, upper=full_model2), direction="both", trace=F)
glmStep_prob2 <- predict(glmStep_model2, newdata=test_subset2, type="response")
prediction_glmStep2 <- as.factor(ifelse(glmStep_prob2 > 0.16, "Yes", "No"))
confusionMatrix(prediction_glmStep2, test_subset2$Attrition, positive="Yes")

# View most important predictors for stepwise model.
glmStep_imp2 <- as.data.frame(varImp(glmStep_model2))
glmStep_imp2 <- data.frame(Overall=glmStep_imp2$Overall, Predictors=rownames(glmStep_imp2))
glmStep_imp2[order(glmStep_imp2$Overall, decreasing=T),]

```

The overall accuracy on this second model goes up slightly to 80.38%, but sensitivity for Attrition actually drops to 67.80%. In this model, Overtime, Stock Option Level, Number of Companies Worked, Job Satisfaction, Work Life Balance, Business Travel, and Environment Satisfaction are among the most important predictors.

#### k-Nearest Neighbors

Another model is k-nearest neighbors, which makes classifications based on Euclidean distances between values. The disparity between ranges means we need to begin by normalizing our numeric values so that they are not the main determinants.

```{r attrition-knn1}

# Create new data frame for normalized numbers. Factorize appropriate columns.
employee_normalize <- data.frame(employee_factor)
employee_normalize %<>% mutate_each(funs(factor(.)), factorize)

# Normalize numeric variables, then cbind back to factors.
normalizeNum <- c("Age", "DailyRate", "DistFromHme", "HourlyRate", "MnthInc", "MnthRate", "NumCoWorked", "PcntSalInc", "TotalWrkYrs", "TrainPrevYr", "YrsAtComp", "YrsCurrRole", "YrsSncPromo", "YrsWtCurMgr")
normNames <- names(employee_normalize) %in% normalizeNum
notnormalized <- employee_normalize[!normNames]
normparameters <- preProcess(employee_normalize[,normalizeNum], method=c("range"))
normalized <- predict(normparameters, employee_normalize[,normalizeNum])
employee_normalize <- cbind(notnormalized, normalized)

# Stratified sampling on Attrition.
set.seed(123)
train_rows3 <- createDataPartition(y=employee_normalize$Attrition, p=0.75, list=F)
train_subset3 <- employee_normalize[train_rows3,]
test_subset3 <- employee_normalize[-train_rows3,]

# Create k-nearest neighbors model on training data, test on testing data.
set.seed(123)
train_control <- trainControl(method="cv", number=10)
knn_model <- train(Attrition~., train_subset3, method='knn', trControl=train_control)
prediction_knn <- predict(knn_model, test_subset3)
confusionMatrix(prediction_knn, test_subset3$Attrition, positive="Yes")

# Show most important variables.
varImp(knn_model)

```

This model has a 82.83% accuracy rate and is good at picking out true negatives. However, its sensitivity for identifying Attrition is very low, at 6.78%. In other words, it is not a good model for picking out those who would attrite. For what it's worth, the model identifies Monthly Income, Total Work Years, Years At Company, Overtime, and Years In Current Role as the most important predictors.

#### Decision Tree/Random Forest

Another classification method is the decision tree. 

```{r attrition-cart}

# Create classification and regression tree model on training data. Print tree visualization and test on testing data.
set.seed(123)
cart_model <- rpart(Attrition ~ ., data=train_subset, method="class")
prp(cart_model)
printcp(cart_model)
prediction_cart <- predict(cart_model, newdata=test_subset, type="class")
confusionMatrix(prediction_cart, test_subset$Attrition, positive="Yes")

```

The decision tree fares slightly better than the k-NN model, with 85.29% overall accuracy and 32.20% sensitivity to Attrition. Still, this is not particularly good for identifying attriting employees.

A random forest model is an ensemble of decision trees. Theoretically, the crowd's perforamnce should exceed that of the individual.

```{r attrition-randomforest}

# Create random forest model on training data, test on testing data.
employee_rf <- randomForest(Attrition ~ ., data=train_subset, ntree=200, mtry=5, importance=T, method="class")
#summary(employee_rf)
# plot(employee_rf)
# print(employee_rf)

rfImpVar <- round(randomForest::importance(employee_rf), 2)
rfImpVar[order(rfImpVar[,3], decreasing=T),]

prediction_rf <- predict(employee_rf, newdata=test_subset, type="class")
confusionMatrix(test_subset$Attrition, prediction_rf, positive="Yes")

```

Indeed, the ensemble method works better. With 86.92% accuracy and 86.67% sensitivity at detecting actual attriting employees, the random forest is our best model among those attempted. While there are more false positives, false negatives (people predicted not to attrite who actually do) are more costly, so minimizing that metric is more important.

This model lists Overtime, Job Role, Total Work Years, and Monthly Income as its overall most important predictors. For predicting those who attrite specifically, Overtime, Job Level, Stock Option Level (likely a symptom of other predictors like Job Level), and Job Satisfaction are most significant, with Age and Monthly Income following behind.

## 4d. Life Satisfaction

One final question of interest posed is whether life satisfaction can be related to this data set. None of the original 35 variables directly address life satisfaction (i.e., the employees were not explicitly asked to rate life satisfaction). Furthermore, criteria for life satisfaction likely varies between employees and some may not even be captured by any of the available variables (e.g., quality of relationships with family and friends, status of physical and mental health, etc). Therefore, the following analysis using the original data set is purely speculative. 

We define a Life Satisfaction variable by averaging Job Satisfaction, Relationship Satisfaction, and Work Life Balance, preexisting variables that capture some aspects of employees' lives both in and out of work. Conveniently, these are all variables in which employees were asked to rate their feelings on a scale of 1 to 4; an actual Life Satisfaction question would likely be answered in a similar fashion. Investigating whether this created variable varies over Age, Monthly Income, and Gender seems like a natural line of inquiry.

```{r life-satisfaction1, message=F, warning=F}

# Collect variables used to calculate life satisfaction. Then, average them to create Life Satisfaction variable.
satisfaction <- c("JobSat", "WorkLifeBal", "RelationSat")
employee_factor$LifeSat <- rowMeans(employee_factor[ , satisfaction])

# Age and Life Satisfaction jittered scatter plot.
DiscVsContScatter(employee_factor, "Age", "LifeSat", "Gender") +
  xlab("Age") + ylab("Life Satisfaction") + 
  ggtitle("Does Life Satisfaction Increase With Age?")

# Monthly Income and Life Satisfaction jittered scatter plot.
DiscVsContScatter(employee_factor, "MnthInc", "LifeSat", "Gender") +
  xlab("Monthly Income") + ylab("Life Satisfaction") +
  ggtitle("Does Money Buy Life Satisfaction?")

```

In the original data definitions, the Satisfaction variables were defined on a 1-4 scale of Low-Medium-High-Very High, while Work-Life Balance was defined as Bad-Good-Better-Best. The scales seem similar enough that our defined Life Satisfaction variable can take on the Low-Medium-High-Very High interpretation.

The linear regression slopes are relatively flat, which could be interpreted in a few different ways. Perhaps Life Satisfaction remains relatively stable across the ranges of Age and Monthly Income. Or maybe no correlation actually exists. Our defined Life Satisfaction variable might not even adequately capture what we want.

Although there is very little change in Life Satisfaction as either Age or Monthly Income increases, the separation by Gender shows an interesting result. Though their confidence intervals contain each other, the mean Life Satisfaction indicated by the linear regression line for Males is higher than Females for all Ages in the data set. For Monthly Income, mean Life Satisfaction is higher for Males below \$10,000, but slightly higher for Females at the high end near \$20,000.

Going forward, explicitly asking a survey question about Life Satisfaction would be helpful if DDSAnalytics wants to know that information.

## Deep Dive

Do the charts/plots again against just the people that have been attrited

```{r eda-attrited-plots1, message=F, warning=F}
attrited <- employee_factor[employee_factor$Attrition == "Yes", ]

# Exploratory histograms of continuous variables on attrited 
attrited %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot(aes(value), fill=Attrition) +
    facet_wrap(~ key, scales="free") +
    geom_histogram() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))
```

```{r eda-attrited-plots2, message=F, warning=F}
# Exploratory bar graphs of factor variables.
attrited %>%
  keep(is.factor) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales="free") +
    geom_bar() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))
```

For those that are attrited, focus on the people at company less than 2 years

```{r eda-attrited-lessthan2yearsAtComp, message=F, warning=F}
attrited.atCoLessThan2Yrs <- attrited[attrited$YrsAtComp < 3,  ]

# Exploratory histograms of continuous variables on attrited 
attrited.atCoLessThan2Yrs %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot(aes(value), fill=Attrition) +
    facet_wrap(~ key, scales="free") +
    geom_histogram() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))
```

```{r eda-attrited-lessthan2yearsAtComp2, message=F, warning=F}
# Exploratory bar graphs of factor variables.
attrited.atCoLessThan2Yrs %>%
  keep(is.factor) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales="free") +
    geom_bar() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))
```

```{r attrition-drilldown}

attrited.atCoLessThan2Yrs
ggplot(attrited.atCoLessThan2Yrs, aes(x=BusTravel, y=..count..)) +
  geom_bar(aes(fill=WorkLifeBal)) +
  coord_flip() +
  ylab("Count") +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())

ggplot(attrited.atCoLessThan2Yrs, aes(x=BusTravel, y=..count..)) +
  geom_bar(aes(fill=WorkLifeBal), position="fill") +
  coord_flip() +
  ylab("Percentage") +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())

ggplot(attrited.atCoLessThan2Yrs, aes(x=WorkLifeBal, y=..count..)) +
  geom_bar(aes(fill=Overtime)) +
  coord_flip() +
  ylab("Count") +
  scale_fill_manual(values=attcol)
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())
ggplot(attrited.atCoLessThan2Yrs, aes(x=Overtime, y=..count..)) +
  geom_bar(aes(fill=WorkLifeBal), position="fill") +
  coord_flip() +
  ylab("Count") +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())
  
```

# Conclusion

## Three factors contributing to turnover.

For our analysis, we found that the following most attributed to the attrition: 

1. Overtime
2. Job Level
3. Stock Option Level
  
* In addition the following factors were included in the model: Overtime, Distance from Home, and Business Travel
  
## Job-specific trends.

The Job specific trends that surfaced with our analysis include:

1. Sales Representatives, Laboratory Technicians, and Human Resources had the largest attrition percentages
2. Sales Representatives are some of the youngest employees.
3. Sales representative also have the lowest total working years, years in current role, years at current company and years with current manager
    

## Other considerations

Our recommendates for next steps and other variables needed are as follows:

1. Provide concrete definition for Life Satisfaction so that it can be included in future analysis
2. The low pay in young, new talent is causing attrition.  Our recommendation is to increase the starting salary of employees. In the long run this will cost you less as you are not having to train and ramp new talent up and then have them leave the company
3. Fresh, new talent is the future and lifeblood of your company - introducing them and having them start off in other parts of the company will only reinforce the idea of inclusion and make them feel they are a part of something and we recommend starting young employees off in other parts of the business so they can grow, learn and feel they are apart of the bigger picture
4. Another component to the analysis we discovered is that overtime was quite high amonth those employees that left.  Our recommendation is to reduce the amount of overtime and offer other incentives for having to work overtime - like extended holiday time, gift cards for family dinner
5. Our analysis uncovered that many folks that were affected by attrition had a long commute.  We recommend offering incentives of either offering a certain limit on toll tag expense, or optional work from home to accomodate those folks
6. We noticed that business travel was high among those who attrited and our recommendation here is to look at web conferencing solutions to reduce the amount of travel.  
7. Lastly we noticed the attrition level was high amonth those that were at a level 0 of Stock Options.  Our recommendation is to invest in your employees by offering higher option level.  One aspect to this that has been successful in the past is to offer stock options to employees with a 4 year vesting period and have yearly refresh grants based on performance.  This will ensure vested interested by employees by seeing a direct correlation in the success of the business will have a positive financial impact for them as well