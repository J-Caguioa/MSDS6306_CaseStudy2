---
title: "Analysis"
author: "Lavonnia Newman, Jeff Washburn, & Joseph Caguioa"
date: "2/25/2019"
output: 
  html_document:
    theme: default
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false

---

```{r setup, include=F, message=F, results="hide", warning=F}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)

package_list <- c("tidyverse", "readxl", "knitr", "mlr", "kableExtra", "corrplot", "ggmosaic", "magrittr", "caret")
lapply(package_list, library, character.only=T)

theme_set(theme_bw())

```

# Introduction

Insert scenario.

Address the following questions in analysis:
* Identify three or more factors that contribute to employee turnover.
* Do other job-specific trends exist?

# 2. Load/Clean Data

```{r load1}

# Read in data set. [#2A]
employee <- read_excel('Data/DDSAnalytics_Data.xlsx', sheet = "HR-employee-attrition Data")

# Size of data set. [#2A]
employee_dim <- as.matrix(dim(employee))
rownames(employee_dim) <- c("Rows", "Columns")
kable(employee_dim, col.names = "Size", row.names = T,
      caption = "Data Set Dimensions", table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

The data set contains observations on 1,470 employees with information on 35 variables.

```{r load2}

# Modify column names. All names less than 12 characters. [#2B]
renamed <- read_excel('Data/VariableNames.xlsx')
colnames(employee) <- renamed$`Modified_Name`

# Convert column types. [#2D]
# factorize <- c("Attrition", "BusinessTravel", "Department", "EducationField", "EnvironmentSatisfaction", "Gender", "JobInvolvement", "JobLevel", "JobRole", "JobSatisfaction", "MaritalStatus", "Over18", "OverTime", "PerformanceRating", "RelationshipSatisfaction", "WorkLifeBalance")
# employee[factorize] <- lapply(employee[factorize], as.factor)

# Another option that converts all to numeric.
# employee <- employee %>% 
#   mutate_if(is.character, as.factor) %>% 
#   mutate_if(is.factor, as.numeric) 

```

# 3. Preliminary Analysis

## 3a. Remove all under 18

```{r underage}

# Remove <18-year-olds. [#3A]
summary(employee$Age)
count(employee, "Over18")

```

The number of "Y" entries for the "Over18" variable agrees with the total number of observations, 1,470. The minimum age, 18, confirms that there are no underage employees in the data set. 


## 3b. Descriptive stats
```{r descriptive,echo=TRUE}
# Descriptive statistics (7) and histograms (2) for interesting variables. [#3B]
# Age, MnthInc, PcntSalInc, YrsAtComp, YrsCurrRole, YrsSncPromo, YrsWtCurMgr

descriptiveStats = employee[c("Age", "MnthInc", "PcntSalInc", "YrsAtComp", "YrsCurrRole", "YrsSncPromo", "YrsWtCurMgr")]

kable(summary(descriptiveStats))


# Descriptive stats - Age
summary(employee$Age)

# Descriptive stats - MnthInc
summary(employee$MnthInc)

# Descriptive stats - PcntSalInc
summary(employee$PcntSalInc)

# Descriptive stats - YrsAtComp
summary(employee$YrsAtComp)

# Descriptive stats - YrsCurrRole
summary(employee$YrsCurrRole)

# Descriptive stats - YrsSncPromo
summary(employee$YrsSncPromo)

# Descriptive stats - YrsWtCurMgr
summary(employee$YrsWtCurMgr)


# Histogram - age
# 
summary(employee$Age)
ggAge = ggplot(employee, aes(Age))
ggAge = ggAge +geom_histogram(breaks=seq(20, 60, by=2), col="black", aes(fill=..count.., y=..density..)) 
ggAge = ggAge +scale_fill_gradient("Count", low="green", high="red")
ggAge = ggAge +geom_density(col="blue")
ggAge = ggAge +labs(title="Histogram for Age", x="Age", y="Density")
ggAge

# Histogram - Income
summary(employee$MnthInc)
ggIncome = ggplot(employee, aes(MnthInc))
ggIncome = ggIncome +geom_histogram(breaks=seq(1000, 22000, by=1000), col="black", aes(fill=..count.., y=..density..))
ggIncome = ggIncome +scale_fill_gradient("Count", low="green", high="red")
ggIncome = ggIncome +geom_density(col="blue")
ggIncome = ggIncome +labs(title="Histogram for Income", x="Income", y="Density")
ggIncome
```

## 3c. Frequencies on Gender, Education Occupation

```{r frequencies}

GenderData<- table(employee$Gender)
kable(GenderData,
      col.names = c("Gender",
                    "Count"),
      row.names = T,
      caption="Headcount By Gender",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


EducationData <- table(employee$Education)
names(EducationData)<-c("Below College", "College", "Bachelor", "Master", "Doctor")
kable(EducationData,
      col.names = c("Education Level", "Count"),
      row.names = T,
      caption="Headcout by Education",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


JobRoleData <- data.frame(table(employee$JobRole))
names(JobRoleData) <- c("Job Roles", "Count")
kable(JobRoleData,
      col.names = c("Job Role", "Count"),
      row.names = T,
      caption="Headcout by Job Role",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

## 3d. Counts of Management positions

```{r management}

manager <- data.frame(JobRoleData[4:6,])
manager

```

## 3e. Further Analysis - Correlation

``` {r correlations1, warning=F}

# Column type conversion. Attrition forced to 1/0 binary. Other character variables coerced to numeric for correlogram.
employee_numeric <- data.frame(employee)
employee_numeric$Attrition <- ifelse(employee_numeric$Attrition == "Yes", 1, 0)
employee_numeric <- employee_numeric %>% mutate_if(is.character, as.factor) %>% mutate_if(is.factor, as.numeric)

employee_factor <- data.frame(employee)
employee_factor <- employee_factor %>% mutate_if(is.character, as.factor)
factor_cols <- c("Education", "EnvironSat", "JobInvolvemt", "JobLevel", "JobSat", "PerfRating", "RelationSat", "StandHours", "StckOptLev", "WorkLifeBal")
employee_factor %<>% mutate_each_(funs(factor(.)), factor_cols)

# Percent of employees who left.
mean(employee_numeric$Attrition)

# Dirty correlogram to show correlating variables for further investigation.
corrplot(cor(employee_numeric), type = "upper", tl.col = "black", tl.srt = 45, tl.cex = 0.5, number.cex = 0.3)

```

For reference, the correlogram shows some correlations between the following variables ("Years%" refers to the last four variables beginning with the word "Years"):

* Age: Education, JobLevel, MonthlyIncome, TotalWorkingYears, Years%
* Department: JobRole
    + Possibly makes sense, as certain job roles tend to be used in certain departments. Cross-reference back to original factors; the numeric coercion may be creating noise.
* Education: NumCompaniesWorked, TotalWorkingYears
* JobLevel: MonthlyIncome, TotalWorkingYears, Years%
* MaritalStatus: StockOptionLevel
* MonthlyIncome: Age, TotalWorkingYears, Years%
    + Likely increases with experience
* NumCompaniesWorked: TotalWorkingYears
* PercentSalaryHike: PerformanceRating
    + According to FAQs, data is self-reported. Performance rating is likely artificially high.
* TotalWorkingYears: Age, JobLevel, MonthlyIncome, Years%
* Years%: Other Years%

```{r correlations2}

# Divorced = 1, Married = 2, Single = 3. All Singles have StockOptionLevel = 0.
table(employee_numeric$MaritalStat, employee_numeric$StckOptLev)

# Overtime 1 = No, 2 = Yes. About the same percentage of people worked overtime, regardless of marital status.
table(employee_numeric$MaritalStat, employee_numeric$Overtime)

# Percentagewise, marital status distributed evenly by job level.
table(employee_numeric$MaritalStat, employee_numeric$JobLevel)

```

Attrition's individual correlations are relatively weak. Perhaps studying interaction effects will show a stronger effect.

* Attrition: Age, EnvironmentSatisfaction, JobInvolvement, JobLevel, JobSatisfaction, MaritalStatus, MonthlyIncome, OverTime, StockOptionLevel, TotalWorkingYears, YearsAtCompany, YearsInCurrentRole, YearsWithCurrManager
    + MaritalStatus and OverTime show positive correlations, the rest are negative. Makes sense in context for some, eg, lower JobInvolvement/Level/Satisfaction increases likelihood of attrition?

## 3f. Further Analysis - Attrition

```{r attrition1}

attrition <- employee_numeric[employee_numeric$Attrition == 1, ]
attrition_summary <- data.frame(do.call('rbind', lapply(attrition, function(x) if(is.numeric(x)) summary(x))))
attrition_summary$Mean <- round(attrition_summary$Mean, digits=2)
colnames(attrition_summary) <- c("Minimum", "1st Quartile", "Median", "Mean", "3rd Quartile", "Maximum")

kable(attrition_summary, row.names = T,
      caption = "Statistics of People Who Left", 
      table.attr="style='width:90%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

ggplot(employee, aes(x=Age, y=MnthInc, color=Gender)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") +
  ylab("Monthly Income ($)") +
  ggtitle("Attrition, Age, & Monthly Income") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  facet_grid(. ~ Attrition)

ggplot(employee, aes(x=YrsAtComp)) +
  geom_histogram() +
  xlab("Years at Company") +
  ylab("Count") +
  ggtitle("Attrition and Years at Company") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  facet_grid(Attrition ~ .)

ggplot(employee, aes(x=YrsCurrRole)) +
  geom_histogram() +
  xlab("Years at Company") +
  ylab("Count") +
  ggtitle("Attrition and Years in Current Role") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  facet_grid(Attrition ~ .)

ggplot(employee, aes(x=TotalWrkYrs)) +
  geom_histogram() +
  xlab("Total Working Years") +
  ylab("Count") +
  ggtitle("Attrition and Total Working Years") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  facet_grid(Attrition ~ .)

ggplot(employee, aes(x=Attrition, y=Education, group=Attrition)) +
  geom_boxplot() +
  xlab("Attrition") +
  ylab("Education Level") +
  ggtitle("Attrition and Education") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5))

prop.table(table(employee_numeric$Attrition, employee_numeric$MaritalStat))

# Row-wise proportion of attrition by job role. Of those who left, 3/7/8/9 are most represented.
prop.table(table(employee_numeric$Attrition, employee_numeric$JobRole), 1)

# Row-wise proportions of attrition vs work-life balance. Slight increase in people with 'bad' (1) work-life balance among those who left.
prop.table(table(employee_numeric$Attrition, employee_numeric$WorkLifeBal), 1)

# Row-wise proportions of attrition vs job satisfaction. For those who left, slight decrease in 'very high' (4) reallocated to 'low' (1).
prop.table(table(employee_numeric$Attrition, employee_numeric$JobSat), 1)

# ggplot(employee, aes(x=StckOptLev, y=Attrition, fill=Attrition)) +
#   geom_col(position="fill")
mosaicplot(Attrition ~ StckOptLev, data = employee)
# ggplot(employee_numeric) +
#   geom_mosaic(aes(x=product(StckOptLev, Attrition), fill=StckOptLev), na.rm=T)

```

```{r attrition2}

# Stratified sampling on Attrition.
set.seed(307)
train_rows <- createDataPartition(y=employee_factor$Attrition, p=0.7, list=F)
train_subset <- employee_factor[train_rows,]
test_subset <- employee_factor[-train_rows,]

# Create task.
train_task <- makeClassifTask(data=train_subset, target="Attrition", positive="Yes")
test_task <- makeClassifTask(data=test_subset, target="Attrition")

train_task

```
#

# 4. Deep Analysis

## 4c. Age and Income

```{r age-income}

# Relationship between Age and Income. [#4C]
cor(employee$Age, employee$MnthInc)

lm1 <- lm(MnthInc ~ Age, employee)
summary(lm1)

ggplot(employee, aes(x=Age, y=MnthInc, color=Gender)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income Rises with Age") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)

par(mfrow=c(2,2))
plot(lm1)

```

A moderate positive correlation (Pearson's r = 0.498) exists between age and monthly income. Drawing a scatterplot between the two shows a general upward trend in income as age increases, and the best-fitting regression line has a positive slope. However, a linear relationship may not be an optimal model for these variables.

```{r income-vs-others}

# Relationship between education and income.
ggplot(employee, aes(x=factor(Education), y=MnthInc, group=Education, fill=Education)) +
  geom_boxplot() +
  xlab("Level of Education") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income and Education") +
  scale_x_discrete(labels = c("Below College",
                              "College",
                              "Bachelor",
                              "Master",
                              "Doctor")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.ticks = element_blank(),
        legend.position = 'none',
        plot.title = element_text(hjust = 0.5))

# Relationship between education field and income.
ggplot(employee, aes(x=EduField, y=MnthInc, group=EduField)) +
  geom_boxplot() +
  coord_flip()

# Total working years vs income
ggplot(employee, aes(x=TotalWrkYrs, y=MnthInc)) +
  geom_point()

lm2 <- lm(MnthInc ~ TotalWrkYrs, employee)
cor(employee$TotalWrkYrs, employee$MnthInc)
# Note: 0.77 cor, R2 ~ 0.597 ***

# Years at company vs income
ggplot(employee, aes(x=YrsAtComp, y=MnthInc)) +
  geom_point()

```

## Job-Specific Trends

```{r job-role}

# Relationship between job role and income.
ggplot(employee, aes(x=JobRole, y=MnthInc, group=JobRole)) +
  geom_boxplot() +
  coord_flip() +
  xlab("Job Role") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income by Job")

ggplot(employee, aes(x=JobRole, y=YrsAtComp, group=JobRole)) +
  geom_boxplot() +
  coord_flip() +
  xlab("Job Role") +
  ylab("Years at Current Company") +
  ggtitle("Years with Current Employer by Job")

ggplot(employee, aes(x=JobRole, y=NumCoWorked, group=JobRole)) +
  geom_boxplot() +
  coord_flip() +
  xlab("Job Role") +
  ylab("Number of Companies Worked") +
  ylim(c(0,10))
  ggtitle("Work History by Job")
  
ggplot(employee, aes(x=JobRole, y=JobSat)) +
  geom_boxplot() +
  coord_flip() +
  xlab("Job Role") +
  ylab("Job Satisfaction") +
  ggtitle("Job Satisfaction by Role")

ggplot(employee, aes(x=JobRole, y=PcntSalInc)) +
  geom_boxplot() +
  coord_flip() +
  xlab("Job Role") +
  ylab("Percent Salary Increase") +
  ggtitle("Yearly Raise by Job")

ggplot(employee, aes(x=JobRole, y=WorkLifeBal)) +
  geom_jitter(alpha=0.3) +
  coord_flip() +
  xlab("Job Role") +
  ylab("Work-Life Balance") +
  ggtitle("Work Life Balance by Job")

```

## 4d. Life Satisfaction

One potential starting point involves using variables with the word "satisfaction" in their name:

* Environment Satisfaction
* Job Satisfaction
* Relationship Satisfaction

Perhaps monthly income should also be considered.

```{r life-satisfaction}

# Can life satisfaction be defined?

```

# Conclusion

* Identify three factors contributing to turnover.
* Identify any existing job-specific trends.
* Other considerations, such as next steps or other variables needed.
