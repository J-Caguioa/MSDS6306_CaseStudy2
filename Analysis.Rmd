---
title: "Analysis"
author: "Lavonnia Newman, Jeff Washburn, & Joseph Caguioa"
date: "2/25/2019"
output: 
  html_document:
    theme: default
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false

---

```{r setup, include=T, message=F, results="hide", warning=F}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)

# Packages used.
package_list <- c("tidyverse", "readxl", "knitr", "mlr", "kableExtra", "corrplot", "ggmosaic", "magrittr", "caret", "randomForest", "reshape", "gridExtra", "GGally", "purrr", "cowplot", "rpart", "rpart.plot", "leaps", "plyr")
lapply(package_list, library, character.only=T)

theme_set(theme_bw())

source('src/MLR-2.R')

# Reusable colors for attrition.
attcol <- c("No"="seagreen3", "Yes"="indianred3")
# Reusable Likert scale colors.
likert <- c("1"="indianred3", "2"="bisque1", "3"="olivedrab3", "4"="springgreen3")

```

# Introduction

DDSAnalytics provides talent management solutions for Fortune 1000 companies. For these highly influential and competitive American companies, employee retention is critical for productivity, morale, and the bottom line. Therefore, identifying factors that could possibly predict employee turnover and then developing appropriate retention strategies is of great interest.

Our team of data scientists will analyze an existing data set of employee survey responses to identify major factors that contributed to attrition. Additionally, we will also point out other interesting trends that may provide insights for future development and retention strategies.

# 2. Load/Clean Data

```{r load1}

# Read in data set. [#2A]
employee <- read_excel('Data/DDSAnalytics_Data.xlsx', sheet = "HR-employee-attrition Data")

# Obtain dimensions. [#2A]
employee_dim <- as.matrix(dim(employee))
rownames(employee_dim) <- c("Rows", "Columns")
kable(employee_dim, col.names = "Size", row.names = T,
      caption = "Data Set Dimensions", table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

The original data set provided by DDSAnalytics contains observations on 1,470 employees with information on 35 variables. In other words, the data set comprises a data frame of 1,470 rows and 35 columns. Whether this data comes from one company or multiple is unspecified.

```{r load2, message=F, warning=F}

# Modify column names. All names less than 12 characters. [#2B]
renamed <- read_excel('Data/VariableNames.xlsx')
colnames(employee) <- renamed$`Modified_Name`

# Convert column types. [#2D]
# Create data frame where all factor-type variables are converted accordingly.
employee_factor <- data.frame(employee)
employee_factor <- employee_factor %>% mutate_if(is.character, as.factor)
#factor_cols <- c("Education", "EmpCount", "EnvironSat", "JobInvolvemt", "JobLevel", "JobSat", "PerfRating", "RelationSat", "StandHours", "StckOptLev", "WorkLifeBal")
#employee_factor %<>% mutate_each(funs(factor(.)), factor_cols)

# Create data frame where all variables are numeric.
employee_numeric <- data.frame(employee_factor)
employee_numeric %<>% mutate_if(is.factor, as.numeric)

```

Two versions of the original employee data frame are created. One converts all character variables and select rating-type numeric variables to factors. The other goes a step further and coerces all variables to numeric. Both are used in different ways during the analysis.

```{r eda-plots1, message=F, warning=F}

# Exploratory histograms of continuous variables.
employee_factor %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot(aes(value), fill=Attrition) +
    facet_wrap(~ key, scales="free") +
    geom_histogram() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))

```

Quick exploratory plots of all 35 variables on all of the data reveal some useful tidbits right off the bat. The histogram shapes alone show some interesting trends.

* Distance From Home, Percent Salary Increase, Total Working Years, Years At Company, Years In Current Role, Years Since Last Promotion, and Years With Current Manager have similar positively skewed distributions with long right tails. Some of these variables are likely correlated with each other.
* Employee ID has a maximum value above 2000. The data set contains only 1,470 observations, meaning this may be a subset where other employee data has already been removed.

```{r eda-plots2, message=F, warning=F}

# Exploratory bar graphs of factor variables.
employee_factor %>%
  keep(is.factor) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales="free") +
    geom_bar() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))

```

Do the charts/plots again against just the people that have been attrited

```{r eda-attrited-plots1, message=F, warning=F}
attrited <- employee_factor[employee_factor$Attrition == "Yes", ]

# Exploratory histograms of continuous variables on attrited 
attrited %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot(aes(value), fill=Attrition) +
    facet_wrap(~ key, scales="free") +
    geom_histogram() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))
```

```{r eda-attrited-plots2, message=F, warning=F}
# Exploratory bar graphs of factor variables.
attrited %>%
  keep(is.factor) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales="free") +
    geom_bar() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))
```

For those that are attrited, focus on the people at company less than 2 years

```{r eda-attrited-lessthan2yearsAtComp, message=F, warning=F}
attrited.atCoLessThan2Yrs <- attrited[attrited$YrsAtComp < 3,  ]

# Exploratory histograms of continuous variables on attrited 
attrited.atCoLessThan2Yrs %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot(aes(value), fill=Attrition) +
    facet_wrap(~ key, scales="free") +
    geom_histogram() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))
```

```{r eda-attrited-lessthan2yearsAtComp2, message=F, warning=F}
# Exploratory bar graphs of factor variables.
attrited.atCoLessThan2Yrs %>%
  keep(is.factor) %>%
  gather() %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales="free") +
    geom_bar() +
    theme(axis.text.x=element_text(size=4, angle=45, vjust=1, hjust=1),
          axis.text.y=element_text(size=6))
```

The exploratory bar graphs are similarly informative.

* Department shows that most employees are in Research & Development, followed by Sales. On a related note, Job Role shows most employees are Sales Executives, Research Scientists, or Laboratory Technicians; Education Field shows most have a background in Life Sciences or Medical. Job Level for most is 1 or 2.
* Employee Count 1 for all employees in the data set because each row corresponds to answers for only one employee.
* Environment Satisfacion, Job Satisfaction, and Relationship Satisfaction have noticeable proportions of dissatisfied employees.
* Over 18 is Yes for all employees (including employees who are 18 years old).
* Performance Rating, defined on a scale of 1 to 4, only has scores of 3 and 4 represented.
* Standard Hours is 80 for all employees in the data set. Assuming a standard 40-hour workweek, all of the represented companies use bi-weekly paychecks.

```{r na}

# Has the Qualtrics system introduced any errors? [#2C]
colSums(is.na(employee_factor))

```

None of the quick graphs above threw any errors indicating that missing values were removed before plotting. There are no NA values for any variable. Furthermore, there are no outliers that could indicate entry errors. It seems reasonable to proceed with the assumption that the data set is correct.

```{r drop}

# Remove <18-year-olds. [#3A]
count(employee, "Over18")

# Remove unnecessary variables.
drop <- c("EmpCount", "EmpId", "Over18", "StandHours")
employee_factor <- employee_factor[ , !(names(employee_factor) %in% drop)]
employee_numeric <- employee_numeric[ , !(names(employee_numeric) %in% drop)]

```

As shown in a bar graph above, the Over 18 variable indicates that all employees are at least 18 years old. Furthermore, its total count matches the total number of observations. The minimum age (shown below), 18, confirms that there are no underage employees in the data set.

Before proceeding further, any variables with no variation (Employee Count, Over 18, and Standard Hours) can be removed because they have no useful information for predictive modeling. Employee ID can also be removed because observations can be tracked by other means. This results in a data frame of 1,470 rows and 31 columns.

# 3. Preliminary Analysis

## 3b. Descriptive stats

The following 2 tables show the descriptive statistics for 7 of the variables which include

+ Age
+ Monthly Income (MnthInc)
+ Percent Salary Increase (PcntSalInc)
+ Years at Company (YrsAtComp)
+ Years at Current Role (YrsCurrRole)
+ Years Since Promotion (YrsSncPromo)
+ Years with Current Manager (YrsWtCurMgr)

```{r descriptive,echo=TRUE}
# Descriptive statistics (7) and histograms (2) for interesting variables. [#3B]
# Age, MnthInc, PcntSalInc, YrsAtComp, YrsCurrRole, YrsSncPromo, YrsWtCurMgr

descriptiveStats1 = employee[c("Age", "MnthInc", "PcntSalInc", "YrsAtComp")]

descriptiveStats2 = employee[c("YrsCurrRole", "YrsSncPromo", "YrsWtCurMgr")]

kable(summary(descriptiveStats1), col.names=c("Age", "Monthly Income", "% Salary Increase", 
                                              "Years at Company")) %>%   
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

kable(summary(descriptiveStats2), col.names=c("Years at Current Role", "Years Since Promotion", 
                                              "Years with Current Manager")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

The followng is a histrogram showing the distribution of Age in the company.  Overlayed on top of the histogram is the density curve and can see that the ages are a bit right tailed distributed with a lot of the workforce between 29 and 35 - a relatively young workforce
```{r echo=T}
# Histogram - age
# 
summary(employee$Age)
ggAge = ggplot(employee, aes(Age))
ggAge = ggAge +geom_histogram(breaks=seq(18, 60, by=2), col="black", aes(fill=..count.., y=..density..)) 
ggAge = ggAge +scale_fill_gradient("Count", low="green", high="red")
ggAge = ggAge +geom_density(col="blue")
ggAge = ggAge +labs(title="Histogram for Age", x="Age", y="Density")
ggAge
```


The following is a histrogram of Monthly Income in the company with an overlay of the density curve showing the distribution of income.  The distribution appears to be right skewed with around 300 employees making around $2000 per month 
```{r, echo=T}
# Histogram - Income
summary(employee$MnthInc)
ggIncome = ggplot(employee, aes(MnthInc))
ggIncome = ggIncome +geom_histogram(breaks=seq(1000, 22000, by=1000), col="black", aes(fill=..count.., y=..density..))
ggIncome = ggIncome +scale_fill_gradient("Count", low="green", high="red")
ggIncome = ggIncome +geom_density(col="blue")
ggIncome = ggIncome +labs(title="Histogram for Income", x="Income", y="Density")
ggIncome
```

## 3c. Frequencies on Gender, Education, Occupation
The table command is used to count the employee data by a specified field type. The gender table shows that 60% of the employees are male in this database.   The education level shows that the highest concentration employees have Bachelor degree follow closely by the Master's degree.   These two positions account for 68% of the overall employee database.
```{r frequencies}

GenderData<- table(employee$Gender)
kable(GenderData,
      col.names = c("Gender",
                    "Count"),
      row.names = T,
      caption="Headcount By Gender",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


EducationData <- table(employee$Education)
names(EducationData)<-c("Below College", "College", "Bachelor", "Master", "Doctor")
kable(EducationData,
      col.names = c("Education Level", "Count"),
      row.names = T,
      caption="Headcount by Education",
      table.attr="style='width:30%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

JobRoleData <- table(employee$JobRole)
kable(JobRoleData,
      col.names = c("Job Role",
                    "Count"),
      row.names = T,
      caption="Headcount By Job Role",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## 3d. Counts of Management positions
Our analysis of the data did not base management positions soley on the job grade.  Two tracks for promotion include the individual contributor and management track.   The management track in our analysis includes positions in which employee line management would exist.   Manager, Manufacturing Director and the Research Director would fall into that category. Using this definition 22% of the positions are management.  All of other positions were not considered as management.

```{r management}

managerRoles<-c("Manager", "Manufacturing Director", "Research Director")
ManagerRoleData<- employee[employee$JobRole %in% managerRoles, ]
ManagerRoleData <- data.frame(table(ManagerRoleData$JobRole))
names(ManagerRoleData) <- c("JobRoles", "Count")
kable(ManagerRoleData,
      col.names = c("Job Role", "Count"),
      row.names = T,
      caption="Headcount by Manager Role",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

# 4. Deep Analysis

## Correlation

DDSAnalytics' main question of interest with this data set is to identify factors contributing to turnover, but other trends in the data may also be useful. Therefore, a visualization that shows how the variables correlate with each other is a good starting point for analysis.

``` {r correlations1, warning=F}

# Show correlating variables for further investigation.
corrplot(cor(employee_numeric), type = "upper", tl.col = "black", tl.srt = 45, tl.cex = 0.5, number.cex = 0.3)

```

The above correlogram requires the fully numeric version of the data frame. Any correlations involving a categorical variable with no intrinsic order, such as the strong negative correlation between Marital Status and Stock Option Level, requires more investigation to determine whether the correlation is meaningful or just a byproduct of the numeric coercion. In this plot, darker colors and larger circles are associated with stronger correlations. Hence, the diagonal of each variable against itself is a dark blue circle that fills its cell, representing an expected Pearson's r of 1.

Some of the following relationships stand out on a cursory exploration:

* Age, Job Level, Monthly Income, Total Working Years, Years At Company, Years In Current Role, Years Since Last Promotion, and Years With Current Manager all show moderate to strong positive correlations with each other. This makes intuitive sense, as an older person with a longer career is more likely to hold higher positions and wield more earning potential. (Age and Monthly Income specifically are further explored in the Age and Income section.) By itself, Age also has weaker positive correlations with amount of Education and Number of Companies Worked.
* Department and Job Role show a strong positive correlation. Though both are categorical variables, the alphabetical organization within both happens to line up such that their numbers trend together, such as Sales Representatives in the Sales department. This is further explored in the Job-Specific Trends section.
* Hourly Rate, Daily Rate, Monthly Rate, and Monthly Income do not show any correlation. This finding is unexpected, as one would expect these monetary variables to show some sort of relationship. This is further explored in the Rates & Income section.
* Performance Rating and Percent Salary Increase show a strong positive correlation; those who perform the best are likely given the biggest pay raises. Sure enough, only employees who reported an Oustanding performance rating (4 out of 4) were rewarded with raises above 20%, as shown below.

```{r performance-payraise}

ggplot(employee_factor, aes(x=PcntSalInc, y=PerfRating)) + 
  geom_point(alpha=0.1, size=3) +
  scale_x_continuous(breaks=seq(10,25, by=5)) +
  scale_y_continuous(breaks=seq(3,4, by=1)) +
  xlab("Percent Salary Increase") +
  ylab("Performance Rating")

```

Individual correlations between Attrition and other variables are relatively weak. Of these, Overtime, Monthly Income, Job Level, and any of the variables related to career length (e.g., Age, Total Working Years) look the most promising. This is further explored in the Predicting Attrition section.

## Rates & Income

The data set contains four variables related to money: Hourly Rate, Daily Rate, Monthly Rate, and Monthly Income. Their data definitions are not well-defined, but it can be reasonably assumed that the "Rate" variables relate to wages earned over the indicated unit of time and the "Income" variable translates to monthly take-home pay. If this were the case, it should be feasible to build a model to describe the relationship between them.

```{r rate-income1, message=F, warning=F}

# Visualize relationship between rates and income. Unable to apply custom attrition palette to ggpairs.
ggpairs(employee_factor, aes(color=Attrition, alpha=0.1), 
        columns=c("HourlyRate", "DailyRate", "MnthRate", "MnthInc"),
        title="Correlation Matrix for Monetary Variables and Attrition",
        axisLabels="none",
        upper=list(continuous=wrap("cor", size=3, hjust=0.8)))

```

Scatterplots of the rates and income variables against each other do not show any discernible relationship; the correlation values, being near zero, would suggest that no relationship exists at all, supporting the earlier observation made about the correlogram. This is an unexpected result, as one would reasonably expect that these variables would trend together. Perhaps another variable not captured by the data, or the survey method by which the data was collected from employees, is responsible.

Another oddity reveals itself when we compare the minimum and maximum values for each variable.

```{r rate-income2}

# Divide data based on which of Monthly Income and Rate is greater.
MnthIncGreater <- summary(employee_factor[which(employee_factor$MnthRate < employee_factor$MnthInc), ])
MnthRateGreater <- summary(employee_factor[which(employee_factor$MnthRate > employee_factor$MnthInc), ])

# Display lower and upper bounds for each category.
employee_money <- data.frame(
  rbind(c(min(employee_numeric$HourlyRate), max(employee_numeric$HourlyRate)),
        c(min(employee_numeric$DailyRate), max(employee_numeric$DailyRate)),
        c(min(employee_numeric$MnthRate), max(employee_numeric$MnthRate)),
        c(min(employee_numeric$MnthInc), max(employee_numeric$MnthInc))))
row.names(employee_money) <- c("Hourly Rate", "Daily Rate", "Monthly Rate", "Monthly Income")
colnames(employee_money) <- c("Minimum", "Maximum")

kable(employee_money,
      col.names = c("Minimum", "Maximum"),
      row.names = T,
      caption="Rates & Income Bounds",
      table.attr="style='width:50%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

For all observations, Monthly Rate is greater than Daily Rate, which in turn is greater than Hourly Rate. This is expected. However, Monthly Rate is greater than Monthly Income for only `r round(mean(employee_numeric$MnthRate > employee_numeric$MnthInc) * 100, digits=2)`% of the observations; in other words, 258 of the 1,470 employees reported a greater Monthly Income than Monthly Rate. Assuming the above interpretation of rate as pre-deduction and income as post-deduction earnings is accurate, why might this be? Investigating the reason for these strange trends is recommended.

## 4c. Age and Income

Analyzing the potential relationship between Age and income is another of DDSAnalytics' questions of interest. Considering the earlier exploratory histograms and our assumed definitions, we use the Monthly Income variable over working with any of the rates.

```{r age-income1}

# Scatterplot on Age, Monthly Income, and Gender. [#4C]
ggplot(employee_factor, aes(x=Age, y=MnthInc, color=Gender)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income Rises with Age") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)

# Obtain linear model and show residual diagnostics.
lm1 <- lm(MnthInc ~ Age, employee_factor)
par(mfrow=c(2,2))
plot(lm1)

```

A moderate positive correlation (Pearson's r = `r cor(employee_factor$Age, employee_factor$MnthInc)`) exists between age and monthly income. Drawing a scatterplot between the two shows a general upward trend in income as age increases, and the best-fitting regression line has a positive slope. 

However, an early exploratory histogram showed that Monthly Income is right-skewed, as is normal for salary distributions. 


However, a linear relationship may not necessarily be an optimal model for these variables.


```{r age-income2}

# Log transform income.
employee_log <- data.frame(employee_factor)
employee_log$LogIncome <- log(employee_log$MnthInc)

ggplot(employee_log, aes(x=LogIncome)) +
  geom_histogram()

# Scatterplot on Age, log(Monthly Income), and Gender.
ggplot(employee_log, aes(x=Age, y=LogIncome, color=Gender)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income Rises with Age") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)


cor(employee_log$Age, employee_log$LogIncome)

```


```{r income-vs-others}

# Relationship between education and income.
ggplot(employee, aes(x=factor(Education), y=MnthInc, group=Education, fill=Education)) +
  geom_boxplot() +
  xlab("Level of Education") +
  ylab("Monthly Income ($)") +
  ggtitle("Monthly Income and Education") +
  scale_x_discrete(labels = c("Below College",
                              "College",
                              "Bachelor",
                              "Master",
                              "Doctor")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.ticks = element_blank(),
        legend.position = 'none',
        plot.title = element_text(hjust = 0.5))

# Relationship between education field and income.
ggplot(employee, aes(x=EduField, y=MnthInc, group=EduField)) +
  geom_boxplot() +
  coord_flip()

# Total working years vs income
ggplot(employee, aes(x=TotalWrkYrs, y=MnthInc)) +
  geom_point()

lm2 <- lm(MnthInc ~ TotalWrkYrs, employee)
cor(employee$TotalWrkYrs, employee$MnthInc)
# Note: 0.77 cor, R2 ~ 0.597 ***

# Years at company vs income
ggplot(employee, aes(x=YrsAtComp, y=MnthInc)) +
  geom_point()

```



## Job-Specific Trends

Employees in this data set fall into nine different job roles. Do some trends apply to certain jobs more than others?

```{r function1}

# Distinct colors, borrowed from https://sashat.me/2017/01/11/list-of-20-simple-distinct-colors/
hardcolors <- c("#E6194B", "#3CB44B", "#FFE119", "#4363D8", "#F58231", "#911EB4", "#42D4F4", "#F032E6", "#BFEF45")
softcolors <- c("#469990", "#E6BEFF", "#800000", "#000075", "#FFFAC8", "#AAFFC3", "#FFD8B1", "#808000", "#9A6324")

# Function that produces ggplot boxplots. Takes nominal groups on x-axis. Prefers continuous variable on y-axis.
ContVsNomBoxplots <- function(df, xvar="groups", yvar="continuous") {
  ggplot(df, aes_string(x=xvar, y=yvar, group=xvar, fill=xvar)) +
    geom_boxplot() +
    scale_fill_manual(values=hardcolors) +
    stat_summary(fun.y=mean, color="black", geom="point", shape=5, size=2) +
    guides(fill=guide_legend(title.position="top", title.hjust=0.5, ncol=2, byrow=F)) +
    theme(axis.text.x=element_blank(),
          axis.text.y=element_text(size=6),
          axis.ticks=element_blank(),
          axis.title=element_blank(),
          legend.key.size=unit(1,"line"),
          legend.position="bottom",
          legend.text=element_text(size=5),
          legend.title=element_text(size=6),
          plot.title = element_text(hjust = 0.5, size=8))
}

```

```{r jobrole1}

# Throwaway graph to obtain common job role legend.
jobrole_age_a <- ContVsNomBoxplots(employee_factor, "JobRole", "Age") +
  scale_fill_manual("Job Roles", values=hardcolors)
jobrole_legend <- get_legend(jobrole_age_a)

# Group 1 of job role boxplots.
# Job Role and Monthly Income boxplots.
jobrole_monthincome <- ContVsNomBoxplots(employee_factor, "JobRole", "MnthInc") + 
  ggtitle("Monthly Income") + theme(legend.position="none")
# Job Role and Percent Salary Increase boxplots.
jobrole_salaryincrease <- ContVsNomBoxplots(employee_factor, "JobRole", "PcntSalInc") +
  ggtitle("Percent Salary Increase") + theme(legend.position="none")
# Job Role and Distance From Home boxplots.
jobrole_distancehome <- ContVsNomBoxplots(employee_factor, "JobRole", "DistFromHme") +
  ggtitle("Distance From Home") + theme(legend.position="none")
# Job Role and Age boxplots.
jobrole_age <- ContVsNomBoxplots(employee_factor, "JobRole", "Age") +
  ggtitle("Age") + theme(legend.position="none")

# Arrange first set of job role boxplots with common legend. 
grid.arrange(jobrole_monthincome, jobrole_salaryincrease, jobrole_distancehome, jobrole_age, jobrole_legend, ncol=3)

```

On average and as a whole, managers and research directors are older and have a higher monthly income. In a similar vein, sales representatives are younger and make the least. Despite their title, manufacturing directors have a monthly income roughly on par with healthcare representatives and sales executives; these three groups have similar age distributions. Fittingly, these trends provide supporting evidence to the earlier exploration of the correlation between age and monthly income.

```{r jobrole2}

# Grouping of boxplots involving years as the continuous variable.
# Job role and total working years boxplots.
jobrole_totalworkyears <- ContVsNomBoxplots(employee_factor, "JobRole", "TotalWrkYrs") +
  ggtitle("Total Work Years") + theme(legend.position="none")
# Job role and years in current role boxplots.
jobrole_currentyears <- ContVsNomBoxplots(employee_factor, "JobRole", "YrsCurrRole") +
  ggtitle("Years in Current Role") + theme(legend.position="none")
# Job role and years at current company boxplots.
jobrole_yearsatcomp <- ContVsNomBoxplots(employee_factor, "JobRole", "YrsAtComp") +
  ggtitle("Years at Current Company") + theme(legend.position="none")
# Job role and years with current manager boxplots.
jobrole_currentmanager <- ContVsNomBoxplots(employee_factor, "JobRole", "YrsWtCurMgr") +
  ggtitle("Years with Current Manager") + theme(legend.position="none")
# Job role and number of companies worked boxplots.
jobrole_numcompanies <- ContVsNomBoxplots(employee_factor, "JobRole", "NumCoWorked") +
  ggtitle("Number of Companies Worked") + theme(legend.position="none") + scale_y_continuous(breaks=seq(0,10, by=2))

# Arrange remaining job role boxplots related to years with common legend.
grid.arrange(jobrole_totalworkyears, jobrole_currentyears, jobrole_yearsatcomp, jobrole_currentmanager, jobrole_numcompanies, jobrole_legend, ncol=3)

```

Perhaps correlated with their age and contributing to their higher monthly income, managers and reserach directors also, as a whole, have the most experience in work years and the longest stays with the company in their present role. Additionally, research directors have, on average, worked at more companies during their career; it's reasonable to assume that they are being well-compensated for their expertise.

On the flipside, young sales representatives also stand out for being early in their careers, with the lowest total working years and years with the company as a group.

```{r jobrole3}

SimpleMean <- function(var) {
  round(mean(var),2)
}

# Table summarizing interval variables by job role.
ddply(employee_factor, .(JobRole), summarize,
      Education=SimpleMean(Education),
      EnvironSat=SimpleMean(EnvironSat),
      JobInvolvemt=SimpleMean(JobInvolvemt),
      JobLevel=SimpleMean(JobLevel),
      JobSat=SimpleMean(JobSat),
      PerfRating=SimpleMean(PerfRating),
      RelationSat=SimpleMean(RelationSat),
      StckOptLevel=SimpleMean(StckOptLev),
      WorkLifeBal=SimpleMean(WorkLifeBal)) %>%
  kable(caption="Job Roles: Means for Interval Variables", align="c",
        col.names=c("Job Role", "Education", "Environment Satisfaction", "Job Involvement", "Job Level", "Job Satisfaction", "Performance Rating", "Relationship Satisfaction", "Stock Option Level", "Work Life Balance")) %>% 
  kable_styling(bootstrap_options=c("striped", "hover", "condensed"), font_size=7)

```

* Research directors, managers, and sales executives are the most well-educated. Average employees in these roles have at least a bachelors degree.
* Managers and research directors have the highest average job level, to which their monthly incomes are likely commensurate.
* Human resources roles report the highest work-life balance and satisfaction in their relationships, but the lowest job satisfaction.
* Sales representatives are the least educated and hold the lowest-level jobs. They report the lowest job involvement and second-highest work-life balance, yet the lowest relationship satisfaction.

```{r jobrole4, message=F, warning=F}

# Reusable theme elements common across stacked barplots.
clean_bar_theme <- theme(axis.text=element_text(size=7),
                         axis.title.x=element_text(size=8),
                         axis.title.y=element_blank(),
                         axis.ticks=element_blank(),
                         legend.justification="left",
                         legend.key.size=unit(1,"line"),
                         legend.text=element_text(size=5),
                         legend.title=element_text(size=10),
                         legend.position="top",
                         plot.title=element_text(size=7))

# Unable to abstract function call to table.
# Job Role and Attrition bar graphs.
job_attrition <- data.frame(with(employee_factor, table(JobRole, Attrition))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=Attrition)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Attrition", values=attcol) +
  clean_bar_theme

# Job Role and Business Travel bar graphs.
job_travel <- data.frame(with(employee_factor, table(JobRole, BusTravel))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=BusTravel)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Business Travel", values=softcolors) +
  clean_bar_theme

# Job Role and Department bar graphs.
job_dept <- data.frame(with(employee_factor, table(JobRole, Department))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=Department)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Department", values=softcolors) +
  clean_bar_theme

# Job Role and Gender bar graphs.
job_gender <- data.frame(with(employee_factor, table(JobRole, Gender))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=Gender)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  clean_bar_theme

# Job Role and Marital Status bar graphs.
job_marital <- data.frame(with(employee_factor, table(JobRole, MaritalStat))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=MaritalStat)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Marital Status", values=softcolors) +
  clean_bar_theme

# Job Role and Overtime bar graphs.
job_overtime <- data.frame(with(employee_factor, table(JobRole, Overtime))) %>%
  ggplot(aes(x=reorder(JobRole, desc(JobRole)), fill=Overtime)) +
  geom_bar(aes(weight=Freq, position="stack")) +
  geom_text(aes(x=JobRole, y=Freq, label=Freq), position=position_stack(vjust=0.5), size=2) +
  coord_flip() +
  ylab("Frequency") +
  scale_fill_manual("Overtime", values=attcol) +
  clean_bar_theme

grid.arrange(job_attrition, job_travel, job_dept, job_gender, job_marital, job_overtime, ncol=2)

```

* Research Directors (2.50%), Managers (4.90%), Healthcare Representatives (6.87%), and Manufacturing Directors (6.89%) have the lowest attrition rates. All other roles have attrition rates near or exceeding the sample's 16.12%. In descending order: Sales Representatives (39.75%), Laboratory Technicians (23.93%), Human Resources (23.07%), Sales Executives (17.48%), and Research Scientists (16.09%).
* 
* Sales Representatives (45.78%) have the highest percentage of singles. Research Directors (28.75%), Manufacturing Directors (27.48%), and Healthcare Representatives (25.95%) have the highest divorce rates.
* Human Resources personnel and some Managers (codified as levels 2 and 4 of Job Role) are in Human Resources (codified as level 1 of Department). Some Managers, plus all Sales Executives and Sales Representatives (levels 4, 8, and 9, of Job Role) are in Sales (level 3 of Department). Some Managers, plus the remaining jobs (levels 1 and 3-7) are in Research & Development (level 2 of Department). In other words, factor numbers for Job Role generally correlate with factor numbers for Department, explaining the observation from the correlogram.

## Predicting Attrition

```{r attrition0, fig.width=3, fig.height=3}

# Pie graph with ggplot.
ggplot(employee_factor, aes(x="", y="", fill=Attrition)) +
  geom_bar(width=1, stat="identity") +
  coord_polar("y", start=0) +
  scale_fill_manual(values=attcol) +
  theme_minimal() +
  theme(axis.title=element_blank(),
        panel.border=element_blank(),
        panel.grid=element_blank(),
        axis.ticks=element_blank())

```

In this data set `r round(mean(employee_factor$Attrition=="Yes")*100, digits=2)`%, or `r sum(employee_factor$Attrition=="Yes")` of the 1470 employees attrited. Analyzing statistics and plots can help develop the profile of this type of employee.

```{r attrition2}

# Subset data and retrieve summary statistics on employees who attrited.
attrited_summary <- data.frame(do.call('rbind', lapply(attrited, function(x) if(is.numeric(x)) round(summary(x),2))))
attrited_summary$Mean <- round(attrited_summary$Mean, digits=2)
colnames(attrited_summary) <- c("Minimum", "1st Quartile", "Median", "Mean", "3rd Quartile", "Maximum")
kable(attrited_summary, row.names = T,
      caption = "Summary Statistics of People Who Left", 
      table.attr="style='width:90%;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

```{r attrition-plots-demographics}

# Function that produces ggplot density plots. Takes continuous variable on x-axis. Intended for group as color.
ContDensity <- function(df, xvar="cont", yvar="groups") {
  ggplot(df, aes_string(x=xvar, color=yvar)) +
    geom_density(alpha=0.3) +
    scale_color_manual(values=attcol) +
    guides(fill=guide_legend(title.position="top", title.hjust=0.5)) +
    theme(axis.text.x=element_text(size=6),
          axis.text.y=element_blank(),
          axis.ticks=element_blank(),
          axis.title=element_blank(),
          legend.key.size=unit(1,"line"),
          legend.position="bottom",
          legend.text=element_text(size=5),
          legend.title=element_text(size=6),
          plot.title = element_text(hjust = 0.5, size=8))
}

# Throwaway graph to obtain common Attrition legend.
att_age_a <- ContDensity(employee_factor, "Age", "Attrition")
attrition_legend <- get_legend(att_age_a)

# Attrition and Age density plot.
att_age <- ContDensity(employee_factor, "Age", "Attrition") +
  ggtitle("Age") + theme(legend.position="none")
  
# Attrition and gender.

# Attrition and marital status.

# Attrition and education level.

# Attrition and education field.

grid.arrange(att_age, ncol=2)

```

```{r attrition-table}

t(ddply(employee_factor, .(Attrition), summarize,
      "Education"=SimpleMean(Education),
      "Environment Satisfaction"=SimpleMean(EnvironSat),
      "Job Involvement"=SimpleMean(JobInvolvemt),
      "Job Level"=SimpleMean(JobLevel),
      "Job Satisfaction"=SimpleMean(JobSat),
      "Performance Rating"=SimpleMean(PerfRating),
      "Relation Satisfaction"=SimpleMean(RelationSat),
      "Stock Option Level"=SimpleMean(StckOptLev),
      "Work Life Balance"=SimpleMean(WorkLifeBal))) %>%
  kable(caption="Attrition: Means for Interval Variables", align="c") %>%
  kable_styling(bootstrap_options=c("striped", "hover", "condensed"), font_size=7)

```

```{r attrition-plots-money}

# Attrition and Monthly Income density plot.
att_monthlyincome <- ContDensity(employee_factor, "MnthInc", "Attrition") +
  ggtitle("Monthly Income") + theme(legend.position="none")
# Attrition and Percent Salary Increase density plot.
att_salaryincrease <- ContDensity(employee_factor, "PcntSalInc", "Attrition") +
  ggtitle("Percent Salary Increase") + theme(legend.position="none")

grid.arrange(att_monthlyincome, att_salaryincrease, attrition_legend, ncol=2)

```

```{r attrition-plots-job}

# Attrition and business travel.
att_bustrav <- ggplot(employee_factor, aes(x=BusTravel, y=..count..)) +
  geom_bar(aes(fill=Attrition), position="fill") +
  coord_flip() +
  ylab("Percentage") +
  scale_fill_manual(values=attcol) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())

att_bustrav2 <- ggplot(employee_factor, aes(x=BusTravel, y=..count..)) +
  geom_bar(aes(fill=Attrition)) +
  coord_flip() +
  ylab("Count") +
  scale_fill_manual(values=attcol) +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())

# Attrition and distance from home.
att_dist <- ggplot(employee_factor, aes(x=DistFromHme, color=Attrition)) +
  geom_density(alpha=0.3) +
  xlab("Distance from Home") +
  ylab("Density")

# Attrition and department.

# Attrition and job involvement.

# Attrition and job level.

# Attrition and job role.

# Attrition and overtime.

# Attrition and performance rating.

grid.arrange(att_bustrav, att_bustrav2, ncol=2)

```

```{r attrition-plots-likert}

#attrited.atCoLessThan2Yrs
ggplot(attrited.atCoLessThan2Yrs, aes(x=BusTravel, y=..count..)) +
  geom_bar(aes(fill=WorkLifeBal)) +
  coord_flip() +
  ylab("Count") +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())

ggplot(attrited.atCoLessThan2Yrs, aes(x=BusTravel, y=..count..)) +
  geom_bar(aes(fill=WorkLifeBal), position="fill") +
  coord_flip() +
  ylab("Percentage") +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())

ggplot(attrited.atCoLessThan2Yrs, aes(x=WorkLifeBal, y=..count..)) +
  geom_bar(aes(fill=Overtime)) +
  coord_flip() +
  ylab("Count") +
  scale_fill_manual(values=attcol)
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())
ggplot(attrited.atCoLessThan2Yrs, aes(x=Overtime, y=..count..)) +
  geom_bar(aes(fill=WorkLifeBal), position="fill") +
  coord_flip() +
  ylab("Count") +
  theme(axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y = element_blank())
  
```

```{r attrition-plots-history}

# Attrition and Number of Companies Worked density plot.
att_numcompanies <- ContDensity(employee_factor, "NumCoWorked", "Attrition") +
  ggtitle("Number of Companies Worked") + theme(legend.position="none")
# Attrition and Total Working Years density plot.
att_totalyears <- ContDensity(employee_factor, "TotalWrkYrs", "Attrition") +
  ggtitle("Total Working Years") + theme(legend.position="none")
# Attrition and Training Times Last Year density plot.
att_monthlyincome <- ContDensity(employee_factor, "TrainPrevYr", "Attrition") +
  ggtitle("Training Times Last Year") + theme(legend.position="none")
# Attrition and Years at Company density plot.
att_yearscomp <- ContDensity(employee_factor, "YrsAtComp", "Attrition") +
  ggtitle("Years At Company") + theme(legend.position="none")
# Attrition and Years In Current Role density plot.
att_yearsrole <- ContDensity(employee_factor, "YrsCurrRole", "Attrition") +
  ggtitle("Years In Current Role") + theme(legend.position="none")
# Attrition and Years Since Last Promotion density plot.
att_yearspromo <- ContDensity(employee_factor, "YrsSncPromo", "Attrition") +
  ggtitle("Years Since Last Promotion") + theme(legend.position="none")
# Attrition and Years With Current Manager density plot.
att_yearsmanager <- ContDensity(employee_factor, "YrsWtCurMgr", "Attrition") +
  ggtitle("Years With Current Manager") + theme(legend.position="none")

grid.arrange(att_numcompanies, att_totalyears, att_monthlyincome, att_yearscomp, att_yearsrole, att_yearspromo, att_yearsmanager, attrition_legend, ncol=4)

```

From the summary statistics and density and mosaic plots, a general profile emerges on what the typical leaving employee generally looks like compared to an employee who stays:

* Younger (especially in the 20s and 30s) and single
* Lower job and relationship satisfaction
* No stock option
* Live further from work and travel more frequently for business
* Hold lower job level
* more likely to be a laboratory technician, research scientist, or sales representative

Which of these factors are the biggest determinants for attrition?

```{r attrition4}

# # Stratified sampling on Attrition.
# set.seed(307)
# train_rows <- createDataPartition(y=employee_factor$Attrition, p=0.7, list=F)
# train_subset <- employee_factor[train_rows,]
# test_subset <- employee_factor[-train_rows,]
# 
# # Create task.
# train_task <- makeClassifTask(data=train_subset, target="Attrition", positive="Yes")
# test_task <- makeClassifTask(data=test_subset, target="Attrition")
# 
# train_task
# 
# train_task <- normalizeFeatures(train_task, method="standardize")
# test_task <- normalizeFeatures(train_task, method="standardize")
# train_task <- dropFeatures(task=train_task, features=c("EmpId", "StandHours"))

```

```{r attrition_glm}

# Replicable stratified sampling on attrition.
set.seed(307)
train_rows <- createDataPartition(y=employee_factor$Attrition, p=0.7, list=F)
train_subset <- employee_factor[train_rows,]
test_subset <- employee_factor[-train_rows,]

employee_glm <- glm(Attrition~., data=employee_factor, family="binomial")
summary(employee_glm)
imp <- as.data.frame(varImp(employee_glm))
imp <- data.frame(overall = imp$Overall, names=rownames(imp))
imp[order(imp$overall, decreasing=T),]

train_glm <- glm(Attrition~., data=train_subset, family="binomial")
summary(train_glm)
imp <- as.data.frame(varImp(train_glm))
imp <- data.frame(overall = imp$Overall, names=rownames(imp))
imp[order(imp$overall, decreasing=T),]

prob <- predict(train_glm, test_subset, type="response")
test_subset$Pred <- ifelse(prob > 0.141, "Yes", "No")
mean(test_subset$Pred == test_subset$Attrition)



```

```{r stepwise}

employee_null <- glm(Attrition ~ 1, data=employee_factor, family="binomial")
employee_full <- glm(Attrition ~ ., data=employee_factor, family="binomial")
employee_step <- step(employee_null, scope=list(lower=employee_null, upper=employee_full), direction="forward", trace=F)
step_prob <- predict(employee_step, type="response")

```

Top via AIC: YrsAtcomp (603.37), YrsCurrRole (604.13), MnthRate (604.18), PerfRating (604.25), Age (604.51)
Invalidate the above. Need to change to using version of employee_factor with certain variables dropped.

```{r caret-stepwise}

set.seed(123)
train_control <- trainControl(method="cv", number=10)
forward <- train(Attrition ~ ., data=employee_numeric, method="leapSeq", tuneGrid=data.frame(nvmax=1:10), trControl = train_control)
forward$bestTune
forward$results
summary(forward$finalModel)

# full <- lm(Attrition ~., data=employee_numeric)
# steptest <- MASS::stepAIC(full, direction="both", trace=F)
# summary(steptest)

```

```{r cart}

employee_cart <- rpart(Attrition ~ ., data=train_subset, method="class")
prp(employee_cart)
printcp(employee_cart)

predict_cart <- predict(employee_cart, newdata=test_subset, type="class")
table(test_subset$Attrition, predict_cart)
(351+15)/(nrow(test_subset))

```

```{r decision_trees}

employee_rf <- randomForest(Attrition ~ ., data=train_subset, ntree=200, mtry=5, importance=T, method="class")
#summary(employee_rf)
plot(employee_rf)
print(employee_rf)

rfImpVar <- round(randomForest::importance(employee_rf), 2)
rfImpVar[order(rfImpVar[,3], decreasing=T),]

```

```{r kmeans}

#employee_kmeans <- kmeans(employee_factor, centers=5, nstart=20)


```

## 4d. Life Satisfaction

One final question of interest posed is whether life satisfaction can be related to this data set. None of the original 35 variables directly address life satisfaction (i.e., the employees were not explicitly asked to rate life satisfaction). Furthermore, criteria for life satisfaction likely varies between employees and some may not even be captured by any of the available variables (e.g., quality of relationships with family and friends, status of physical and mental health, etc). Therefore, the following analysis using the original data set is purely speculative. 

The three variables containing "satisfaction" in their name (Environment Satisfaction, Job Satisfaction, and Relationship Satisfaction) provide a reasonable starting point. Work Life Balance also seems sound. Incidentally, these are all variables in which employees were asked to rate their feelings on a scale of 1 to 4.

If career success were a major contributor to life satisfaction, several of the available variables may be useful. Education, Job Level, Monthly Income, and Total Working Years may capture some general job progression.

```{r life-satisfaction1, message=F, results="hide", warning=F}

# satisfy_var <- c("Age", "Attrition", "BusTravel", "EnvironSat", "JobInvolvemt", "JobSat", "MaritalStat", "MnthInc", "RelationSat", "TotalWrkYrs", "WorkLifeBal")
# employee_satisfaction <- employee_factor[ , (names(employee_factor) %in% satisfy_var)]
# dist_matrix <- dist(employee_satisfaction)
# employee_hclust <- hclust(d = dist_matrix)
# cutree(employee_hclust, h=6)
# plot(employee_hclust)

```

```{r life-satisfaction2}

# Collect variables used to calculate life satisfaction. Then, aggregate them to create Life Satisfaction variable.
satisfaction <- c("EnvironSat", "JobSat", "RelationSat", "WorkLifeBal")
employee_numeric$LifeSat <- rowMeans(employee_numeric[ , satisfaction])


ggplot(employee_numeric, aes(x=Age, y=LifeSat)) +
  geom_point(alpha=0.3) +
  xlab("Age (years)") + ylab("Life Satisfaction") + ggtitle("Life Satisfaction Tester") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)

ggplot(employee_numeric, aes(x=MnthInc, y=LifeSat)) +
  geom_point(alpha=0.3) +
  xlab("Monthly Income") + ylab("Life Satisfaction") + ggtitle("Life Satisfaction Tester") +
  theme(axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm",
              se = F,
              level = 0.95)

```



# Conclusion

* Identify three factors contributing to turnover.
```{r prediction}
#ourPredict(employee)
```
* Identify any existing job-specific trends.
* Other considerations, such as next steps or other variables needed.
